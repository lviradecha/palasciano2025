<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palasciano Red Cross Camp Napoli</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        // ==================== FUNZIONI DI STAMPA ====================

        const printBadgeLabel = (nome, cognome) => {
    const printWindow = window.open('', '_blank', 'width=500,height=300');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Etichetta - ${nome} ${cognome}</title>
            <style>
                @page { size: 53mm 12mm; margin: 0; }
                @media print { body { margin: 0; padding: 0; } }
                body {
                    width: 53mm; height: 12mm; margin: 0; padding: 0;
                            display: flex; align-items: center; justify-content: center;
                            font-family: Arial, sans-serif; background: white;
                        }
                        .label-content { text-align: center; width: 100%; padding: 0 2mm; }
                        .nome { font-size: 8pt; font-weight: bold; text-transform: uppercase; line-height: 1.2; margin: 0; }
                    </style>
                </head>
                <body>
                    <div class="label-content">
                        <div class="nome">${nome} ${cognome}</div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.print();
                setTimeout(() => printWindow.close(), 500);
            }, 250);
        };

        const printRegistroPresenze = (participants, selectedDate) => {
            const participantsWithAccess = participants.filter(p => 
                (p.accessi || []).some(a => a.data === selectedDate)
            );

            const presenti = participantsWithAccess.filter(p => {
                const acc = (p.accessi || []).find(a => a.data === selectedDate);
                return acc && acc.status === 1;
            });

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Registro Presenze - ${selectedDate}</title>
                    <style>
                        @page { size: A4; margin: 15mm; }
                        body { font-family: Arial, sans-serif; font-size: 11pt; }
                        h1 { text-align: center; color: #4f46e5; margin-bottom: 5mm; font-size: 18pt; }
                        h2 { text-align: center; color: #666; font-size: 14pt; margin-bottom: 10mm; }
                        table { width: 100%; border-collapse: collapse; margin-top: 5mm; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #4f46e5; color: white; font-weight: bold; }
                        tr:nth-child(even) { background-color: #f9f9f9; }
                        .firma { width: 150px; }
                        .orario { width: 80px; text-align: center; }
                        .footer { margin-top: 20mm; display: flex; justify-content: space-between; }
                        @media print { body { print-color-adjust: exact; -webkit-print-color-adjust: exact; } }
                    </style>
                </head>
                <body>
                    <h1>üè• Palasciano Red Cross Camp Napoli 2025</h1>
                    <h2>üìã Registro Presenze - ${new Date(selectedDate).toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</h2>
                    
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 40px;">N.</th>
                                <th>Cognome</th>
                                <th>Nome</th>
                                <th>Comitato</th>
                                <th class="orario">Arrivo</th>
                                <th class="firma">Firma</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${participantsWithAccess.map((p, index) => {
                                const accesso = (p.accessi || []).find(a => a.data === selectedDate);
                                const orario = accesso && accesso.dataCheckin ? 
                                    new Date(accesso.dataCheckin).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit', timeZone: 'Europe/Rome' }) : 
                                    '-';
                                return `
                                    <tr>
                                        <td style="text-align: center;">${index + 1}</td>
                                        <td><strong>${p.cognome}</strong></td>
                                        <td>${p.nome}</td>
                                        <td style="font-size: 9pt;">${p.comitato}</td>
                                        <td class="orario">${orario}</td>
                                        <td class="firma"></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <div>
                            <p><strong>Totale partecipanti:</strong> ${participantsWithAccess.length}</p>
                            <p><strong>Presenti:</strong> ${presenti.length}</p>
                            <p><strong>Assenti:</strong> ${participantsWithAccess.length - presenti.length}</p>
                        </div>
                        <div style="text-align: right;">
                            <p>_________________________</p>
                            <p style="margin-top: 5mm;">Firma Responsabile</p>
                        </div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(() => printWindow.print(), 250);
        };

        const printCheckinList = (participants, selectedDate) => {
            const participantsWithAccess = participants.filter(p => 
                (p.accessi || []).some(a => a.data === selectedDate)
            );

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Lista Check-in - ${selectedDate}</title>
                    <style>
                        @page { size: A4; margin: 10mm; }
                        body { font-family: Arial, sans-serif; font-size: 10pt; }
                        h1 { text-align: center; color: #4f46e5; margin-bottom: 3mm; font-size: 16pt; }
                        h2 { text-align: center; color: #666; font-size: 12pt; margin-bottom: 8mm; }
                        .participant { 
                            border: 2px solid #ddd; padding: 8px; margin-bottom: 8px; 
                            page-break-inside: avoid; display: flex;
                            justify-content: space-between; align-items: center;
                        }
                        .info { flex: 1; }
                        .info h3 { margin: 0 0 5px 0; font-size: 12pt; color: #333; }
                        .info p { margin: 2px 0; font-size: 9pt; color: #666; }
                        .qr-placeholder { 
                            width: 60px; height: 60px; border: 2px dashed #999; 
                            display: flex; align-items: center; justify-content: center;
                            font-size: 8pt; color: #999;
                        }
                        .status { 
                            display: inline-block; padding: 3px 8px; border-radius: 4px; 
                            font-size: 8pt; font-weight: bold;
                        }
                        .presente { background-color: #d1fae5; color: #065f46; }
                        .assente { background-color: #fee2e2; color: #991b1b; }
                    </style>
                </head>
                <body>
                    <h1>üè• Palasciano Red Cross Camp Napoli 2025</h1>
                    <h2>‚úÖ Lista Check-in - ${new Date(selectedDate).toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</h2>
                    
                    ${participantsWithAccess.map((p, index) => {
                        const accesso = (p.accessi || []).find(a => a.data === selectedDate);
                        const isPresente = accesso && accesso.status === 1;
                        const orario = accesso && accesso.dataCheckin ? 
                            new Date(accesso.dataCheckin).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit', timeZone: 'Europe/Rome' }) : 
                            'Non effettuato';
                        
                        return `
                            <div class="participant">
                                <div class="info">
                                    <h3>${index + 1}. ${p.nome} ${p.cognome}</h3>
                                    <p><strong>CF:</strong> ${p.cf}</p>
                                    <p><strong>Comitato:</strong> ${p.comitato} (${p.regione})</p>
                                    <p><strong>Tipo:</strong> ${p.tipoPartecipazione || 'Non specificato'}</p>
                                    <p><strong>Check-in:</strong> ${orario} 
                                        <span class="status ${isPresente ? 'presente' : 'assente'}">
                                            ${isPresente ? '‚úì PRESENTE' : '‚úó ASSENTE'}
                                        </span>
                                    </p>
                                </div>
                                <div class="qr-placeholder">QR</div>
                            </div>
                        `;
                    }).join('')}
                    
                    <div style="margin-top: 15mm; text-align: center; color: #666; font-size: 9pt;">
                        <p>Documento generato il ${new Date().toLocaleString('it-IT')}</p>
                        <p><strong>Totale:</strong> ${participantsWithAccess.length} partecipanti</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(() => printWindow.print(), 250);
};// ==================== COMPONENTE CAMBIO PASSWORD ====================

        function ChangePasswordModal({ user, onSuccess, onLogout }) {
            const [formData, setFormData] = useState({
                newPassword: '',
                confirmPassword: ''
            });
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');

                if (formData.newPassword.length < 8) {
                    setError('La password deve essere almeno 8 caratteri');
                    return;
                }

                if (formData.newPassword !== formData.confirmPassword) {
                    setError('Le password non corrispondono');
                    return;
                }

                setLoading(true);

                try {
                    const response = await fetch('/.netlify/functions/change-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: user.id,
                            newPassword: formData.newPassword
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('‚úÖ Password cambiata con successo!');
                        onSuccess();
                    } else {
                        setError(result.error || 'Errore nel cambio password');
                    }
                } catch (error) {
                    setError('Errore di connessione');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-8">
                        <div className="text-center mb-6">
                            <div className="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span className="text-3xl">üîê</span>
                            </div>
                            <h2 className="text-2xl font-bold text-gray-900 mb-2">Cambio Password Obbligatorio</h2>
                            <p className="text-gray-600">
                                Ciao <strong>{user.nome}</strong>, √® il tuo primo accesso.<br/>
                                Per motivi di sicurezza, devi cambiare la password.
                            </p>
                        </div>

                        {error && (
                            <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
                                ‚ùå {error}
                            </div>
                        )}

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium mb-1">Nuova Password</label>
                                <input
                                    type="password"
                                    required
                                    minLength="8"
                                    value={formData.newPassword}
                                    onChange={(e) => setFormData({...formData, newPassword: e.target.value})}
                                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500"
                                    placeholder="Minimo 8 caratteri"
                                />
                                <p className="text-xs text-gray-500 mt-1">La password deve contenere almeno 8 caratteri</p>
                            </div>

                            <div>
                                <label className="block text-sm font-medium mb-1">Conferma Password</label>
                                <input
                                    type="password"
                                    required
                                    value={formData.confirmPassword}
                                    onChange={(e) => setFormData({...formData, confirmPassword: e.target.value})}
                                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500"
                                    placeholder="Ripeti la password"
                                />
                            </div>

                            <div className="pt-4 space-y-3">
                                <button
                                    type="submit"
                                    disabled={loading}
                                    className="w-full px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 font-semibold"
                                >
                                    {loading ? '‚è≥ Salvataggio...' : 'üíæ Cambia Password'}
                                </button>

                                <button
                                    type="button"
                                    onClick={onLogout}
                                    disabled={loading}
                                    className="w-full px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 disabled:opacity-50"
                                >
                                    ‚Üê Esci
                                </button>
                            </div>
                        </form>

                        <div className="mt-6 pt-6 border-t">
                            <p className="text-xs text-gray-500 text-center">
                                üí° Scegli una password sicura che non hai usato altrove
                            </p>
                        </div>
                    </div>
                </div>
            );
        }// ==================== DASHBOARD PUBBLICA ====================

function PublicDashboard() {
    const [stats, setStats] = useState(null);
    const [loading, setLoading] = useState(true);
    const [countdown, setCountdown] = useState(30);
    const [currentTime, setCurrentTime] = useState(new Date());

    // Carica statistiche
    const loadStats = async () => {
        try {
            const response = await fetch('/.netlify/functions/get-dashboard-stats');
            const result = await response.json();
            if (result.success) {
                setStats(result.stats);
            }
        } catch (error) {
            console.error('Errore caricamento stats:', error);
        } finally {
            setLoading(false);
        }
    };

    // Carica al mount e ogni 30 secondi
    useEffect(() => {
        loadStats();
        const interval = setInterval(() => {
            loadStats();
            setCountdown(30);
        }, 30000);
        return () => clearInterval(interval);
    }, []);

    // Countdown
    useEffect(() => {
        const timer = setInterval(() => {
            setCountdown(prev => prev > 0 ? prev - 1 : 30);
        }, 1000);
        return () => clearInterval(timer);
    }, []);

    // Orologio
    useEffect(() => {
        const timer = setInterval(() => {
            setCurrentTime(new Date());
        }, 1000);
        return () => clearInterval(timer);
    }, []);

    if (loading) {
        return (
            <div className="min-h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 flex items-center justify-center">
                <div className="text-center">
                    <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-white mx-auto mb-4"></div>
                    <p className="text-white text-xl">Caricamento dashboard...</p>
                </div>
            </div>
        );
    }

    if (!stats) {
        return (
            <div className="min-h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 flex items-center justify-center">
                <div className="text-white text-xl">Errore caricamento dati</div>
            </div>
        );
    }

    const percentualeArriviOggi = stats.arriviOggi.previsti > 0 
        ? Math.round((stats.arriviOggi.arrivati / stats.arriviOggi.previsti) * 100) 
        : 0;

    const percentualePresenza = stats.generali.totale > 0
        ? Math.round((stats.presentiOggi / stats.generali.totale) * 100)
        : 0;

    return (
        <div className="min-h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 p-6">
            {/* HEADER */}
            <div className="bg-white rounded-2xl shadow-2xl p-8 mb-6">
                <div className="flex justify-between items-center">
                    <div>
                        <h1 className="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600">
                            üè• Palasciano Red Cross Camp Napoli 2025
                        </h1>
                        <p className="text-xl text-gray-600 mt-2">Dashboard Live - Monitoraggio in Tempo Reale</p>
                    </div>
                    <div className="text-right">
                        <p className="text-3xl font-bold text-gray-900">
                            {currentTime.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}
                        </p>
                        <p className="text-lg text-gray-600">
                            {currentTime.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
                        </p>
                    </div>
                </div>
            </div>

            {/* STATISTICHE PRINCIPALI */}
<div className="grid grid-cols-6 gap-6 mb-6">
    <div className="bg-white rounded-xl shadow-xl p-6 border-l-4 border-indigo-500">
        <p className="text-gray-500 text-sm font-semibold uppercase mb-2">üë• Totale</p>
        <p className="text-5xl font-bold text-gray-900">{stats.generali.totale}</p>
    </div>
    
    <div className="bg-white rounded-xl shadow-xl p-6 border-l-4 border-blue-500">
        <p className="text-gray-500 text-sm font-semibold uppercase mb-2">üìù Pre-accreditamento</p>
        <p className="text-5xl font-bold text-blue-600">{stats.generali.preiscritti}</p>
    </div>
    
    <div className="bg-white rounded-xl shadow-xl p-6 border-l-4 border-orange-500">
        <p className="text-gray-500 text-sm font-semibold uppercase mb-2">üöó Check-in</p>
        <p className="text-5xl font-bold text-orange-600">{stats.generali.checkin}</p>
    </div>
    
    <div className="bg-white rounded-xl shadow-xl p-6 border-l-4 border-green-500">
        <p className="text-gray-500 text-sm font-semibold uppercase mb-2">üéâ Accreditati</p>
        <p className="text-5xl font-bold text-green-600">{stats.generali.accreditati}</p>
    </div>
    
    <div className="bg-white rounded-xl shadow-xl p-6 border-l-4 border-purple-500">
        <p className="text-gray-500 text-sm font-semibold uppercase mb-2">üëã Check-out</p>
        <p className="text-5xl font-bold text-purple-600">{stats.generali.checkout}</p>
    </div>

    <div className="bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl shadow-xl p-6">
        <p className="text-white text-sm font-semibold uppercase mb-2">‚úÖ Presenti Oggi</p>
        <p className="text-5xl font-bold text-white">{stats.presentiOggi}</p>
        <p className="text-emerald-100 text-sm mt-1">{percentualePresenza}% del totale</p>
    </div>
</div>

            <div className="grid grid-cols-2 gap-6 mb-6">
                {/* ARRIVI PREVISTI OGGI */}
                <div className="bg-white rounded-xl shadow-xl p-6">
                    <h3 className="text-2xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <span>üìä</span> Arrivi Previsti Oggi
                    </h3>
                    <div className="space-y-4">
                        <div className="flex justify-between items-center">
                            <span className="text-gray-600 font-medium">Previsti:</span>
                            <span className="text-3xl font-bold text-gray-900">{stats.arriviOggi.previsti}</span>
                        </div>
                        <div className="flex justify-between items-center">
                            <span className="text-gray-600 font-medium">Arrivati:</span>
                            <span className="text-3xl font-bold text-green-600">{stats.arriviOggi.arrivati}</span>
                        </div>
                        <div className="flex justify-between items-center">
                            <span className="text-gray-600 font-medium">In attesa:</span>
                            <span className="text-3xl font-bold text-orange-600">{stats.arriviOggi.previsti - stats.arriviOggi.arrivati}</span>
                        </div>
                        <div className="mt-4">
                            <div className="flex justify-between text-sm mb-2">
                                <span className="font-semibold">Percentuale arrivi</span>
                                <span className="font-bold">{percentualeArriviOggi}%</span>
                            </div>
                            <div className="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                                <div 
                                    className="bg-gradient-to-r from-green-400 to-green-600 h-4 rounded-full transition-all duration-500"
                                    style={{ width: `${percentualeArriviOggi}%` }}
                                ></div>
                            </div>
                        </div>
                    </div>
                </div>

                {/* PRESENZE PER GIORNO */}
                <div className="bg-white rounded-xl shadow-xl p-6">
                    <h3 className="text-2xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <span>üìà</span> Presenze per Giorno
                    </h3>
                    <div className="space-y-3">
                        {stats.presenzeGiornaliere.map(giorno => {
                            const percentuale = giorno.previsti > 0 ? Math.round((giorno.presenti / giorno.previsti) * 100) : 0;
                            const dataObj = new Date(giorno.data);
                            const isToday = giorno.data === new Date().toISOString().split('T')[0];
                            
                            return (
                                <div key={giorno.data} className={`${isToday ? 'bg-indigo-50 border-2 border-indigo-300 rounded-lg p-3' : ''}`}>
                                    <div className="flex justify-between items-center mb-2">
                                        <span className={`font-semibold ${isToday ? 'text-indigo-700' : 'text-gray-700'}`}>
                                            {dataObj.toLocaleDateString('it-IT', { weekday: 'short', day: 'numeric', month: 'short' })}
                                            {isToday && ' (Oggi)'}
                                        </span>
                                        <span className="font-bold text-lg">
                                            {giorno.presenti} / {giorno.previsti}
                                        </span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                        <div 
                                            className={`h-2 rounded-full transition-all ${isToday ? 'bg-gradient-to-r from-indigo-400 to-indigo-600' : 'bg-gradient-to-r from-blue-400 to-blue-600'}`}
                                            style={{ width: `${percentuale}%` }}
                                        ></div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            </div>

            <div className="grid grid-cols-3 gap-6 mb-6">
                {/* PROVENIENZA */}
                <div className="bg-white rounded-xl shadow-xl p-6">
                    <h3 className="text-2xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <span>üèõÔ∏è</span> Provenienza
                    </h3>
                    <div className="space-y-3">
                        {stats.perRegione.slice(0, 8).map((reg, index) => {
                            const percentuale = Math.round((reg.totale / stats.generali.totale) * 100);
                            return (
                                <div key={index}>
                                    <div className="flex justify-between items-center mb-1">
                                        <span className="text-gray-700 font-medium">{reg.regione || 'Non specificato'}</span>
                                        <span className="font-bold">{reg.totale} ({percentuale}%)</span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-2">
                                        <div 
                                            className="bg-gradient-to-r from-purple-400 to-pink-600 h-2 rounded-full"
                                            style={{ width: `${percentuale}%` }}
                                        ></div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>

                {/* TIPO PARTECIPAZIONE */}
                <div className="bg-white rounded-xl shadow-xl p-6">
                    <h3 className="text-2xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <span>üë•</span> Tipo Partecipazione
                    </h3>
                    <div className="space-y-4">
                        {stats.perTipo.map((tipo, index) => {
                            const percentuale = Math.round((tipo.totale / stats.generali.totale) * 100);
                            const colori = {
                                'Corsista': 'from-blue-400 to-blue-600',
                                'Staff': 'from-green-400 to-green-600',
                                'Trainer': 'from-orange-400 to-orange-600',
                                'Ospite': 'from-purple-400 to-purple-600'
                            };
                            return (
                                <div key={index}>
                                    <div className="flex justify-between items-center mb-1">
                                        <span className="text-gray-700 font-medium">{tipo.tipo_partecipazione || 'Non specificato'}</span>
                                        <span className="font-bold">{tipo.totale} ({percentuale}%)</span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-2">
                                        <div 
                                            className={`bg-gradient-to-r ${colori[tipo.tipo_partecipazione] || 'from-gray-400 to-gray-600'} h-2 rounded-full`}
                                            style={{ width: `${percentuale}%` }}
                                        ></div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>

                {/* MODALIT√Ä VIAGGIO */}
                <div className="bg-white rounded-xl shadow-xl p-6">
                    <h3 className="text-2xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <span>üöó</span> Modalit√† Arrivo
                    </h3>
                    <div className="space-y-4">
                        {stats.perViaggio.map((viaggio, index) => {
                            const percentuale = Math.round((viaggio.totale / stats.generali.totale) * 100);
                            const colori = {
                                'Mezzo CRI': 'from-red-400 to-red-600',
                                'Mezzi Pubblici': 'from-blue-400 to-blue-600',
                                'Mezzo Privato': 'from-green-400 to-green-600'
                            };
                            return (
                                <div key={index}>
                                    <div className="flex justify-between items-center mb-1">
                                        <span className="text-gray-700 font-medium">{viaggio.viaggio}</span>
                                        <span className="font-bold">{viaggio.totale} ({percentuale}%)</span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-2">
                                        <div 
                                            className={`bg-gradient-to-r ${colori[viaggio.viaggio] || 'from-gray-400 to-gray-600'} h-2 rounded-full`}
                                            style={{ width: `${percentuale}%` }}
                                        ></div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            </div>

            {/* FOOTER */}
            <div className="bg-white rounded-xl shadow-xl p-4">
                <div className="flex justify-between items-center">
                    <div className="flex items-center gap-2 text-gray-600">
                        <span className="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
                        <span className="font-medium">Dashboard Live</span>
                    </div>
                    <div className="text-gray-600">
                        <span className="font-medium">‚è±Ô∏è Ultimo aggiornamento:</span> {new Date().toLocaleTimeString('it-IT')}
                    </div>
                    <div className="text-gray-600">
                        <span className="font-medium">üîÑ Prossimo aggiornamento tra:</span> <span className="font-bold text-indigo-600">{countdown}s</span>
                    </div>
                </div>
            </div>
        </div>
    );
}        // ==================== COMPONENTE APP ====================

        function App() {
    // ‚úÖ Leggi parametro URL per dashboard pubblica
    const urlParams = new URLSearchParams(window.location.search);
    const initialView = urlParams.get('view') === 'dashboard-public' ? 'dashboard-public' : 'home';
    
    const [view, setView] = useState(initialView);
    const [participants, setParticipants] = useState([]);
            const [emailLog, setEmailLog] = useState([]);
            const [userRole, setUserRole] = useState(null);
            const [currentUser, setCurrentUser] = useState(null);
            const [toast, setToast] = useState({ show: false, message: '' });
            const [loading, setLoading] = useState(true);

            // Verifica sessione attiva
            useEffect(() => {
                const savedUser = sessionStorage.getItem('currentUser');
                if (savedUser) {
                    try {
                        const user = JSON.parse(savedUser);
                        setCurrentUser(user);
                        setUserRole(user.ruolo);
                        setView('dash');
                    } catch (e) {
                        console.error('Errore recupero sessione:', e);
                    }
                }
            }, []);

            useEffect(() => {
                if (userRole) {
                    loadParticipants();
                }
            }, [userRole]);

            const loadParticipants = async () => {
                try {
                    setLoading(true);
                    const response = await fetch('/.netlify/functions/get-participants');
                    const result = await response.json();
                    
                    if (result.success) {
                        setParticipants(result.participants);
                        console.log('‚úÖ Caricati', result.participants.length, 'partecipanti');
                    }
                } catch (error) {
                    console.error('‚ùå Errore caricamento:', error);
                    showToast('‚ùå Errore caricamento dati');
                } finally {
                    setLoading(false);
                }
            };

            const showToast = (msg) => {
                setToast({ show: true, message: msg });
                setTimeout(() => setToast({ show: false, message: '' }), 3000);
            };

            const generateQR = (data) => {
                const tempDiv = document.createElement('div');
                tempDiv.style.display = 'none';
                document.body.appendChild(tempDiv);
                
                const qr = new QRCode(tempDiv, {
                    text: JSON.stringify(data),
                    width: 300,
                    height: 300,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                const canvas = tempDiv.querySelector('canvas');
                const dataUrl = canvas.toDataURL('image/png');
                document.body.removeChild(tempDiv);
                
                return dataUrl;
            };

            const sendEmail = async (p, type) => {
                const qr = generateQR({ id: p.id, nome: p.nome, cognome: p.cognome, cf: p.cf });
                const subject = type === 'welcome' ? 'üéâ Benvenuto al Palasciano Red Cross Camp Napoli!' : '‚úÖ Conferma Preiscrizione - Palasciano Red Cross Camp Napoli';
                
                const htmlContent = `<!DOCTYPE html><html><head><meta charset="UTF-8"></head><body style="font-family:Arial,sans-serif;background:#f3f4f6;padding:20px;"><div style="max-width:600px;margin:0 auto;background:white;border-radius:8px;overflow:hidden;"><div style="background:linear-gradient(135deg,#4f46e5,#6366f1);padding:40px 20px;text-align:center;"><h1 style="color:white;margin:0;font-size:28px;">Palasciano Red Cross Camp Napoli</h1><p style="color:#e0e7ff;margin:10px 0 0;">Campo di Formazione CRI 2025</p></div><div style="padding:40px 30px;"><h2 style="color:#1f2937;margin:0 0 20px;">Ciao ${p.nome}!</h2><p style="color:#4b5563;line-height:1.6;margin:0 0 20px;">${type === 'welcome' ? 'Benvenuto al Palasciano Red Cross Camp Napoli! Sei stato accreditato con successo. Ti aspettiamo!' : 'Siamo felici di confermare la tua preiscrizione al Campo di Formazione Palasciano Red Cross Camp Napoli 2025.'}</p>${type !== 'welcome' ? `<div style="text-align:center;margin:30px 0;"><p style="color:#4b5563;margin:0 0 15px;font-weight:600;">Il Tuo QR Code Personale</p><img src="${qr}" alt="QR Code" style="width:250px;height:250px;border:3px solid #4f46e5;border-radius:12px;"/><p style="color:#6b7280;margin:15px 0 0;font-size:13px;">Presenta questo QR Code durante il check-in</p></div>` : ''}<div style="background:#f9fafb;padding:20px;border-radius:8px;margin:20px 0;"><p style="margin:0 0 10px;color:#6b7280;font-size:14px;"><strong>Nome:</strong> ${p.nome} ${p.cognome}</p><p style="margin:0 0 10px;color:#6b7280;font-size:14px;"><strong>CF:</strong> ${p.cf}</p><p style="margin:0 0 10px;color:#6b7280;font-size:14px;"><strong>Tipo:</strong> ${p.tipoPartecipazione || 'Non specificato'}</p><p style="margin:0 0 10px;color:#6b7280;font-size:14px;"><strong>Comitato:</strong> ${p.comitato}</p><p style="margin:0 0 10px;color:#6b7280;font-size:14px;"><strong>Regione:</strong> ${p.regione}</p><p style="margin:0;color:#6b7280;font-size:14px;"><strong>Periodo:</strong> ${p.arrivo} / ${p.partenza}</p></div><p style="color:#4b5563;margin:20px 0 0;"><strong>Un caro saluto,</strong><br><span style="color:#4f46e5;font-weight:600;">Lo Staff Palasciano Red Cross Camp Napoli</span></p></div><div style="background:#f9fafb;padding:30px 20px;text-align:center;border-top:1px solid #e5e7eb;"><p style="color:#6b7280;margin:0;font-size:14px;">Croce Rossa Italiana</p></div></div></body></html>`;

                try {
                    const response = await fetch('/.netlify/functions/send-email', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ recipient: p.email, subject: subject, htmlContent: htmlContent, qrData: { id: p.id, nome: p.nome, cognome: p.cognome, cf: p.cf } })
                    });

                    const result = await response.json();
                    if (result.success) {
                        const log = { id: Date.now(), timestamp: new Date().toISOString(), recipient: p.email, name: `${p.nome} ${p.cognome}`, subject: subject, qr: qr, messageId: result.messageId };
                        setEmailLog(prev => [log, ...prev]);
                    }
                } catch (error) {
                    console.error('‚ùå Errore email:', error);
                }
            };

            const addParticipant = async (data) => {
    try {
        showToast('‚è≥ Registrazione in corso...');
        
        // ‚úÖ Chiama la nuova function ottimizzata
        const response = await fetch('/.netlify/functions/register-participant', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('‚úÖ Preiscrizione completata! Riceverai l\'email a breve.');
        } else {
            showToast('‚ùå ' + (result.error || 'Errore durante la registrazione'));
        }
    } catch (error) {
        console.error('Errore registrazione:', error);
        showToast('‚ùå Errore di connessione. Riprova.');
    }
};

            const updateParticipant = async (id, data) => {
    try {
        // Trova partecipante originale per confrontare le modifiche
        const original = participants.find(p => p.id === id);
        
        if (!original) {
            showToast('‚ùå Partecipante non trovato');
            return;
        }
        
        // Verifica se sono cambiate date o dati critici
        const dateChanged = original.arrivo !== data.arrivo || original.partenza !== data.partenza;
        const datiImportantiCambiati = 
            original.nome !== data.nome || 
            original.cognome !== data.cognome || 
            original.cf !== data.cf ||
            original.email !== data.email;
        
        // Aggiorna nel database
        const response = await fetch('/.netlify/functions/update-participant', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ...data, id })
        });
        
        const result = await response.json();
        
        if (result.success) {
            await loadParticipants();
            showToast('‚úèÔ∏è Partecipante aggiornato');
            
            // ‚úÖ CHIEDI SE VUOI INVIARE EMAIL CON DATI AGGIORNATI
            if (dateChanged || datiImportantiCambiati) {
                const modifiche = [];
                if (datiImportantiCambiati) modifiche.push('dati anagrafici');
                if (dateChanged) modifiche.push('date arrivo/partenza');
                
                const conferma = confirm(
                    `üìß Sono stati modificati: ${modifiche.join(' e ')}\n\n` +
                    `Vuoi inviare una nuova email a ${data.nome} ${data.cognome} con i dati aggiornati?\n\n` +
                    `L'email conterr√† il QR Code e le nuove informazioni.`
                );
                
                if (conferma) {
                    // Ricarica il partecipante aggiornato dal server per avere i dati completi
                    const updatedParticipants = await (await fetch('/.netlify/functions/get-participants')).json();
                    const updatedParticipant = updatedParticipants.participants.find(p => p.id === id);
                    
                    if (updatedParticipant) {
                        await sendEmail(updatedParticipant, 'registration');
                        showToast('‚úÖ Email inviata con successo!');
                    }
                }
            }
        } else {
            showToast('‚ùå Errore aggiornamento');
        }
    } catch (error) {
        console.error('Errore update:', error);
        showToast('‚ùå Errore');
    }
};

            const deleteParticipant = async (id) => {
                if (!confirm('Eliminare questo partecipante?')) return;
                try {
                    const response = await fetch('/.netlify/functions/delete-participant', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id })
                    });
                    if ((await response.json()).success) {
                        await loadParticipants();
                        showToast('üóëÔ∏è Eliminato');
                    }
                } catch (error) {
                    showToast('‚ùå Errore');
                }
            };

            const stats = {
                total: participants.length,
                preiscritti: participants.filter(p => p.status === 'preiscritto').length,
                checkin: participants.filter(p => p.status === 'checkin').length,
                accreditati: participants.filter(p => p.status === 'accreditato').length,
                checkout: participants.filter(p => p.status === 'checkout').length
            };
// ‚úÖ DASHBOARD PUBBLICA
if (view === 'dashboard-public') {
    return <PublicDashboard />;
}
            // ‚úÖ CONTROLLO PRIMO ACCESSO - MOSTRA CAMBIO PASSWORD
            if (userRole && currentUser && currentUser.primoAccesso) {
                return <ChangePasswordModal 
                    user={currentUser} 
                    onSuccess={() => {
                        setCurrentUser({...currentUser, primoAccesso: false});
                        sessionStorage.setItem('currentUser', JSON.stringify({...currentUser, primoAccesso: false}));
                    }} 
                    onLogout={() => {
                        setUserRole(null);
                        setCurrentUser(null);
                        sessionStorage.removeItem('currentUser');
                        setView('home');
                    }} 
                />;
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
                    <header className="bg-white shadow-lg">
                        <div className="max-w-7xl mx-auto px-4 py-4">
                            <img src="/images/banner.jpg" alt="Palasciano Red Cross Camp Napoli" className="w-full h-auto max-h-32 object-contain" />
                        </div>
                    </header>
                    {!userRole && view === 'home' && <RegistrationForm onSubmit={addParticipant} onAdminClick={() => setView('login')} onDashboardClick={() => setView('dashboard-public')} />}
                    {view === 'login' && !userRole && <LoginForm onLogin={(role, user) => { setUserRole(role); setCurrentUser(user); setView('dash'); }} onBack={() => setView('home')} />}
                    {userRole && (loading ? (
                        <div className="flex items-center justify-center min-h-[50vh]">
                            <div className="text-center">
                                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                                <p className="text-gray-600">Caricamento...</p>
                            </div>
                        </div>
                    ) : (
                        <Dashboard participants={participants} emailLog={emailLog} stats={stats} userRole={userRole} currentUser={currentUser} onUpdate={updateParticipant} onDelete={deleteParticipant} onSendEmail={sendEmail} generateQR={generateQR} onReload={loadParticipants} onLogout={() => { setUserRole(null); setCurrentUser(null); sessionStorage.removeItem('currentUser'); setView('home'); }} />
                    ))}
                    {toast.show && (
                        <div className="fixed top-4 right-4 z-50 bg-green-50 border border-green-200 rounded-lg shadow-lg p-4">
                            <p className="font-medium text-green-900">{toast.message}</p>
                        </div>
                    )}
                </div>
            );
        }// ==================== FORM REGISTRAZIONE ====================

        function RegistrationForm({ onSubmit, onAdminClick, onDashboardClick }) {
    const [form, setForm] = useState({ nome: '', cognome: '', cf: '', tel: '', email: '', tipoPartecipazione: '', comitato: '', regione: '', arrivo: '', partenza: '', viaggio: '', targa: '', veicolo: '' });
    const [success, setSuccess] = useState(false);
    const regions = ['Abruzzo', 'Basilicata', 'Calabria', 'Campania', 'Emilia-Romagna', 'Friuli-Venezia Giulia', 'Lazio', 'Liguria', 'Lombardia', 'Marche', 'Molise', 'Piemonte', 'Puglia', 'Sardegna', 'Sicilia', 'Toscana', 'Trentino-Alto Adige', 'Umbria', "Valle d'Aosta", 'Veneto'];
    const tipiPartecipazione = ['Corsista', 'Ospite', 'Staff', 'Trainer'];

    const handleSubmit = async (e) => {
        e.preventDefault();
        await onSubmit(form);
        setForm({ nome: '', cognome: '', cf: '', tel: '', email: '', tipoPartecipazione: '', comitato: '', regione: '', arrivo: '', partenza: '', viaggio: '', targa: '', veicolo: '' });
        setSuccess(true);
        setTimeout(() => setSuccess(false), 5000);
    };
    return (
        <div className="max-w-3xl mx-auto px-4 py-8">
            <div className="bg-white rounded-lg shadow-xl p-8">
                {/* PULSANTI IN ALTO A DESTRA */}
                <div className="flex justify-end mb-8 gap-3">
                    <button 
                        type="button" 
                        onClick={onAdminClick} 
                        className="px-5 py-2.5 bg-white border-2 border-indigo-600 text-indigo-600 rounded-lg hover:bg-indigo-600 hover:text-white font-semibold shadow-md transition-all hover:shadow-lg flex items-center gap-2"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                        <span>Area Riservata</span>
                    </button>
                    
                    <button 
                        type="button" 
                        onClick={onDashboardClick}
                        className="px-5 py-2.5 bg-white border-2 border-purple-600 text-purple-600 rounded-lg hover:bg-purple-600 hover:text-white font-semibold shadow-md transition-all hover:shadow-lg flex items-center gap-2"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="3" y1="9" x2="21" y2="9"></line>
                            <line x1="9" y1="21" x2="9" y2="9"></line>
                        </svg>
                        <span>Dashboard Live</span>
                    </button>
                </div>
                
                <h2 className="text-2xl font-bold mb-6">üìù Pre-accreditamento Online</h2>
                
                {success && (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onClick={() => setSuccess(false)}>
                        <div className="bg-white rounded-2xl max-w-lg w-full p-8 shadow-2xl animate-pulse-once" onClick={(e) => e.stopPropagation()}>
                            <div className="text-center">
                                <div className="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-6">
                                    <svg className="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                </div>
                                
                                <h2 className="text-3xl font-bold text-gray-900 mb-4">
									üéâ Pre-accreditamento Completato!
								</h2>

								<p className="text-lg text-gray-700 mb-6">
									Il tuo pre-accreditamento √® stato confermato con successo.
								</p>
                                
                                <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 mb-6 border-2 border-indigo-200">
                                    <div className="flex items-start gap-3 mb-4">
                                        <span className="text-2xl">üìß</span>
                                        <div className="text-left flex-1">
                                            <p className="font-semibold text-gray-900 mb-1">Email di Conferma</p>
                                            <p className="text-sm text-gray-700">
                                                Riceverai a breve un'email con il tuo <strong>QR Code personale</strong> e tutti i dettagli del pre-accreditamento.
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <div className="flex items-start gap-3">
                                        <span className="text-2xl">üì±</span>
                                        <div className="text-left flex-1">
                                            <p className="font-semibold text-gray-900 mb-1">Al Check-in</p>
                                            <p className="text-sm text-gray-700">
                                                Presenta il QR Code ricevuto via email per completare l'accreditamento all'evento.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                                    <p className="text-sm text-yellow-800">
                                        üí° <strong>Suggerimento:</strong> Se non ricevi l'email entro 5 minuti, controlla la cartella spam
                                    </p>
                                </div>
                                
                                <button 
                                    onClick={() => setSuccess(false)}
                                    className="w-full px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold text-lg transition-all hover:shadow-lg"
                                >
                                    ‚úÖ Ho Capito
                                </button>
                            </div>
                        </div>
                    </div>
                )}
                
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="block text-sm font-medium mb-1">Nome *</label><input required type="text" value={form.nome} onChange={(e) => setForm({...form, nome: e.target.value})} className="w-full px-3 py-2 border rounded-lg" /></div>
                        <div><label className="block text-sm font-medium mb-1">Cognome *</label><input required type="text" value={form.cognome} onChange={(e) => setForm({...form, cognome: e.target.value})} className="w-full px-3 py-2 border rounded-lg" /></div>
                    </div>
                    <div><label className="block text-sm font-medium mb-1">Codice Fiscale *</label><input required type="text" maxLength="16" value={form.cf} onChange={(e) => setForm({...form, cf: e.target.value.toUpperCase()})} className="w-full px-3 py-2 border rounded-lg" /></div>
                    <div><label className="block text-sm font-medium mb-1">Tipo Partecipazione *</label><select required value={form.tipoPartecipazione} onChange={(e) => setForm({...form, tipoPartecipazione: e.target.value})} className="w-full px-3 py-2 border rounded-lg"><option value="">Seleziona tipo</option>{tipiPartecipazione.map(t => <option key={t} value={t}>{t}</option>)}</select></div>
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="block text-sm font-medium mb-1">Cellulare *</label><input required type="tel" value={form.tel} onChange={(e) => setForm({...form, tel: e.target.value})} className="w-full px-3 py-2 border rounded-lg" /></div>
                        <div><label className="block text-sm font-medium mb-1">Email *</label><input required type="email" value={form.email} onChange={(e) => setForm({...form, email: e.target.value})} className="w-full px-3 py-2 border rounded-lg" /></div>
                    </div>
                    <div><label className="block text-sm font-medium mb-1">Comitato CRI *</label><input required type="text" value={form.comitato} onChange={(e) => setForm({...form, comitato: e.target.value})} className="w-full px-3 py-2 border rounded-lg" /></div>
                    <div><label className="block text-sm font-medium mb-1">Regione *</label><select required value={form.regione} onChange={(e) => setForm({...form, regione: e.target.value})} className="w-full px-3 py-2 border rounded-lg"><option value="">Seleziona</option>{regions.map(r => <option key={r} value={r}>{r}</option>)}</select></div>
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="block text-sm font-medium mb-1">Data Arrivo *</label><input required type="date" value={form.arrivo} onChange={(e) => setForm({...form, arrivo: e.target.value})} className="w-full px-3 py-2 border rounded-lg" /></div>
                        <div><label className="block text-sm font-medium mb-1">Data Partenza *</label><input required type="date" value={form.partenza} onChange={(e) => setForm({...form, partenza: e.target.value})} className="w-full px-3 py-2 border rounded-lg" /></div>
                    </div>
                    <div><label className="block text-sm font-medium mb-1">Modalit√† Viaggio *</label><select required value={form.viaggio} onChange={(e) => setForm({...form, viaggio: e.target.value})} className="w-full px-3 py-2 border rounded-lg"><option value="">Seleziona</option><option>Mezzo CRI</option><option>Mezzi Pubblici</option><option>Mezzo Privato</option></select></div>
                    {(form.viaggio === 'Mezzo CRI' || form.viaggio === 'Mezzo Privato') && (
                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 space-y-3">
                            <h3 className="font-medium">üöó Info Veicolo</h3>
                            <input required type="text" placeholder="Targa" value={form.targa} onChange={(e) => setForm({...form, targa: e.target.value.toUpperCase()})} className="w-full px-3 py-2 border rounded-lg" />
                            <input required type="text" placeholder="Marca e Modello" value={form.veicolo} onChange={(e) => setForm({...form, veicolo: e.target.value})} className="w-full px-3 py-2 border rounded-lg" />
                        </div>
                    )}
                    <button type="submit" className="w-full px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold">‚úÖ Completa Pre-accreditamento</button>
                </form>
            </div>
        </div>
    );
}
   
        // ==================== NUOVO LOGIN FORM CON DATABASE ====================

        function LoginForm({ onLogin, onBack }) {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleLogin = async (e) => {
                if (e) e.preventDefault();
                
                if (!username || !password) {
                    setError('Inserisci username e password');
                    return;
                }

                setLoading(true);
                setError('');

                try {
                    const response = await fetch('/.netlify/functions/auth-login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });

                    const result = await response.json();

                    if (result.success) {
                        sessionStorage.setItem('currentUser', JSON.stringify(result.user));
                        onLogin(result.user.ruolo, result.user);
                    } else {
                        setError(result.error || 'Login fallito');
                    }
                } catch (error) {
                    console.error('Errore login:', error);
                    setError('Errore di connessione. Riprova.');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
                        <div className="text-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-900">üîê Accesso Staff</h2>
                            <p className="text-sm text-gray-600 mt-2">Palasciano Red Cross Camp Napoli 2025</p>
                        </div>

                        {error && (
                            <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                                <p className="text-red-800 text-sm">‚ùå {error}</p>
                            </div>
                        )}

                        <form onSubmit={handleLogin} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium mb-2">Username</label>
                                <input 
                                    type="text" 
                                    value={username}
                                    onChange={(e) => setUsername(e.target.value.toLowerCase())}
                                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500"
                                    placeholder="mario.rossi"
                                    autoFocus
                                    disabled={loading}
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium mb-2">Password</label>
                                <input 
                                    type="password" 
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    onKeyDown={(e) => e.key === 'Enter' && handleLogin()}
                                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500"
                                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                    disabled={loading}
                                />
                            </div>

                            <button 
                                type="submit"
                                disabled={loading || !username || !password}
                                className="w-full px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed font-semibold"
                            >
                                {loading ? '‚è≥ Accesso in corso...' : 'üîì Accedi'}
                            </button>

                            <button 
                                type="button"
                                onClick={onBack}
                                disabled={loading}
                                className="w-full px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 disabled:opacity-50"
                            >
                                ‚Üê Torna alla Preiscrizione
                            </button>
                        </form>

                        <div className="mt-6 pt-6 border-t text-center">
                            <p className="text-xs text-gray-500">
                                üí° <strong>Primo accesso?</strong> Controlla la tua email per le credenziali
                            </p>
                            <p className="text-xs text-gray-500 mt-2">
                                üîí Password dimenticata? Contatta l'amministratore
                            </p>
                        </div>
                    </div>
                </div>
            );
        }// ==================== DASHBOARD ====================

        function Dashboard({ participants, emailLog, stats, userRole, currentUser, onUpdate, onDelete, onSendEmail, generateQR, onReload, onLogout }) {
            const [tab, setTab] = useState('all');
            const [search, setSearch] = useState('');
            const [edit, setEdit] = useState(null);
            const [showQR, setShowQR] = useState(null);
            const [showScanner, setShowScanner] = useState(false);
            const [scannerInstance, setScannerInstance] = useState(null);
            const [showStaffManagement, setShowStaffManagement] = useState(false);
            const [showAuditLog, setShowAuditLog] = useState(false);

            const permissions = {
                canDelete: userRole === 'ADMIN',
                canEdit: userRole === 'ADMIN' || userRole === 'STAFF_ACCREDITAMENTO',
                canSendEmail: userRole === 'ADMIN',
                canExportCSV: userRole === 'ADMIN' || userRole === 'STAFF_ACCREDITAMENTO',
                canViewEmail: userRole === 'ADMIN'
            };

            const getRoleBadge = () => {
                const badges = {
                    'ADMIN': { text: 'Amministratore', color: 'bg-purple-100 text-purple-800' },
                    'STAFF_CHECKIN': { text: 'Staff Check-in', color: 'bg-blue-100 text-blue-800' },
                    'STAFF_ACCREDITAMENTO': { text: 'Staff Accreditamento', color: 'bg-green-100 text-green-800' }
                };
                return badges[userRole];
            };

            const filtered = participants.filter(p => p.nome.toLowerCase().includes(search.toLowerCase()) || p.cognome.toLowerCase().includes(search.toLowerCase()) || p.email.toLowerCase().includes(search.toLowerCase()));

            const startScanner = () => {
    setShowScanner(true);
    let isProcessing = false; // ‚ö†Ô∏è FLAG per evitare scansioni multiple
    
    setTimeout(() => {
        const html5QrCode = new Html5Qrcode("qr-reader");
                    
                    html5QrCode.start(
                        { facingMode: "environment" },
                        { fps: 10, qrbox: { width: 250, height: 250 } },
                        async (decodedText) => {
                            try {
                                const data = JSON.parse(decodedText);
                                if (data.id && data.nome && data.cognome) {
                                    const participant = participants.find(p => p.id === data.id);
                                    if (participant) {
                                        if (participant.status === 'preiscritto') {
                                            console.log('üîç Dati staff user che sto inviando:', currentUser);
											console.log('üîç Oggetto che invio al backend:', {
											id: currentUser.id,
											username: currentUser.username,
											nome: currentUser.nome,
											cognome: currentUser.cognome
											});
											
											const response = await fetch('/.netlify/functions/check-in-scan', {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify({ 
                                                    qrData: data,
                                                    staffUser: currentUser ? {
                                                        id: currentUser.id,
                                                        username: currentUser.username,
                                                        nome: currentUser.nome,
                                                        cognome: currentUser.cognome
                                                    } : null
                                                })
                                            });
                                            
                                            const result = await response.json();
                                            
                                            if (result.success) {
                                                html5QrCode.stop();
                                                setScannerInstance(null);
                                                setShowScanner(false);
                                                
                                                if (result.action === 'first_checkin') {
                                                    printBadgeLabel(data.nome, data.cognome);
                                                }
                                                
                                                await onReload();
                                                alert(`‚úÖ Check-in completato!\n\n${data.nome} ${data.cognome}\nCF: ${data.cf}\n\n${result.action === 'first_checkin' ? 'Stampa etichetta in corso...' : ''}`);
                                            }
                                        } else if (participant.status === 'checkin') {
                                            if (confirm(`${data.nome} ${data.cognome} √® gi√† in check-in.\n\nVuoi accreditarlo?`)) {
                                                const response = await fetch('/.netlify/functions/check-in-scan', {
                                                    method: 'POST',
                                                    headers: { 'Content-Type': 'application/json' },
                                                    body: JSON.stringify({ 
                                                        qrData: data,
                                                        staffUser: currentUser ? {
                                                            id: currentUser.id,
                                                            username: currentUser.username,
                                                            nome: currentUser.nome,
                                                            cognome: currentUser.cognome
                                                        } : null
                                                    })
                                                });
                                                
                                                const result = await response.json();
                                                
                                                if (result.success) {
                                                    html5QrCode.stop();
                                                    setScannerInstance(null);
                                                    setShowScanner(false);
                                                    await onReload();
                                                }
                                            }
                                        } else {
                                            alert(`‚úÖ ${data.nome} ${data.cognome}\n√® gi√† accreditato!`);
                                        }
                                    } else {
                                        alert('‚ùå Partecipante non trovato!');
                                    }
                                } else {
                                    alert('‚ùå QR Code non valido!');
                                }
                            } catch (e) {
    console.error('üîç Errore parsing QR:', e);
    console.error('üîç Testo QR ricevuto:', decodedText);
    alert('‚ùå Errore lettura QR!\n\n' + e.message);
}
                        },
                        (errorMessage) => {}
                    ).catch(err => {
                        console.error('Errore fotocamera:', err);
                        setScannerInstance(null);
                        setShowScanner(false);
                        alert('‚ùå Impossibile avviare la fotocamera.\n\nVerifica di aver concesso i permessi al browser per accedere alla fotocamera.');
                    });
                }, 100);
            };

            const stopScanner = () => {
                if (scannerInstance) {
                    scannerInstance.stop().then(() => {
                        setScannerInstance(null);
                        setShowScanner(false);
                    }).catch((err) => {
                        console.error('Errore stop scanner:', err);
                        setScannerInstance(null);
                        setShowScanner(false);
                    });
                } else {
                    setShowScanner(false);
                }
            };

            const startScannerCheckout = () => {
                setShowScanner(true);
                setTimeout(() => {
                    const html5QrCode = new Html5Qrcode("qr-reader");
                    setScannerInstance(html5QrCode);
                    
                    html5QrCode.start(
                        { facingMode: "environment" },
                        { fps: 10, qrbox: { width: 250, height: 250 } },
                        async (decodedText) => {
                            try {
                                const data = JSON.parse(decodedText);
                                if (data.id && data.nome && data.cognome) {
                                    const participant = participants.find(p => p.id === data.id);
                                    if (participant && participant.status === 'accreditato') {
                                        const response = await fetch('/.netlify/functions/checkout-scan', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ 
                                                qrData: data,
                                                staffUser: currentUser ? {
                                                    id: currentUser.id,
                                                    username: currentUser.username,
                                                    nome: currentUser.nome,
                                                    cognome: currentUser.cognome
                                                } : null
                                            })
                                        });
                                        const result = await response.json();
                                        if (result.success) {
                                            html5QrCode.stop();
                                            setScannerInstance(null);
                                            setShowScanner(false);
                                            alert(`üëã Check-out completato!\n\n${data.nome} ${data.cognome}`);
                                            await onReload();
                                        } else {
                                            alert(result.message || 'Errore check-out');
                                        }
                                    } else {
                                        alert(`‚ùå ${data.nome} ${data.cognome}\nnon pu√≤ fare check-out.\nStatus: ${participant?.status || 'sconosciuto'}`);
                                    }
                                }
                            } catch (e) {
                                alert('‚ùå Errore lettura QR!');
                            }
                        },
                        (errorMessage) => {}
                    ).catch(err => {
                        console.error('Errore fotocamera:', err);
                        setScannerInstance(null);
                        setShowScanner(false);
                        alert('‚ùå Impossibile avviare la fotocamera.\n\nVerifica di aver concesso i permessi al browser.');
                    });
                }, 100);
            };

            const onUpdateStatus = async (id, status) => {
                const qrData = { id };
                const response = await fetch('/.netlify/functions/check-in-scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        qrData,
                        staffUser: currentUser ? {
                            id: currentUser.id,
                            username: currentUser.username,
                            nome: currentUser.nome,
                            cognome: currentUser.cognome
                        } : null
                    })
                });
                const result = await response.json();
                if (result.success) {
                    if (result.participant.needsEmail) { await onSendEmail(result.participant, 'welcome'); }
                    await onReload();
                }
            };return (
                <div className="max-w-7xl mx-auto px-4 py-8">
                    {/* HEADER CON BADGE RUOLO E PULSANTI ADMIN */}
                    <div className="mb-6 flex items-center justify-between flex-wrap gap-4">
                        <div className="flex items-center gap-3 flex-wrap">
                            <div className="flex flex-col">
                                <span className={`px-4 py-2 rounded-lg text-sm font-semibold ${getRoleBadge().color}`}>
                                    {getRoleBadge().text}
                                </span>
                                {currentUser && (
                                    <span className="text-xs text-gray-600 mt-1 px-2">
                                        üë§ {currentUser.nome} {currentUser.cognome}
                                    </span>
                                )}
                            </div>
                            
                            {userRole === 'ADMIN' && (
                                <>
                                    <button 
                                        onClick={() => setShowStaffManagement(true)}
                                        className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold flex items-center gap-2"
                                    >
                                        üë• Gestione Staff
                                    </button>
                                    
                                    <button 
                                        onClick={() => setShowAuditLog(true)}
                                        className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold flex items-center gap-2"
                                    >
                                        üìä Audit Log
                                    </button>
                                </>
                            )}
                        </div>
                        <button onClick={onLogout} className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 text-sm">
                            üö™ Esci
                        </button>
                    </div>

                    {/* STATISTICHE */}
                    <div className="grid grid-cols-5 gap-6 mb-8">
                        <div className="bg-white rounded-lg shadow p-6"><p className="text-gray-500 text-sm">Totale</p><p className="text-3xl font-bold">{stats.total}</p></div>
                        <div className="bg-white rounded-lg shadow p-6"><p className="text-gray-500 text-sm">Pre-accreditamento</p><p className="text-3xl font-bold text-blue-600">{stats.preiscritti}</p></div>
                        <div className="bg-white rounded-lg shadow p-6"><p className="text-gray-500 text-sm">Check-in</p><p className="text-3xl font-bold text-orange-600">{stats.checkin}</p></div>
                        <div className="bg-white rounded-lg shadow p-6"><p className="text-gray-500 text-sm">Accreditati</p><p className="text-3xl font-bold text-green-600">{stats.accreditati}</p></div>
                        <div className="bg-white rounded-lg shadow p-6"><p className="text-gray-500 text-sm">Check-out</p><p className="text-3xl font-bold text-purple-600">{stats.checkout}</p></div>
                    </div>

                    {/* TABS E CONTENUTO */}
                    <div className="bg-white rounded-lg shadow">
                        <div className="flex border-b overflow-x-auto">
                            <button onClick={() => setTab('all')} className={`px-6 py-3 whitespace-nowrap ${tab === 'all' ? 'border-b-2 border-indigo-600 text-indigo-600 font-semibold' : 'text-gray-600'}`}>Tutti ({stats.total})</button>
                            <button onClick={() => setTab('preiscritto')} className={`px-6 py-3 whitespace-nowrap ${tab === 'preiscritto' ? 'border-b-2 border-indigo-600 text-indigo-600 font-semibold' : 'text-gray-600'}`}>Pre-accreditamento ({stats.preiscritti})</button>
                            <button onClick={() => setTab('checkin')} className={`px-6 py-3 whitespace-nowrap ${tab === 'checkin' ? 'border-b-2 border-indigo-600 text-indigo-600 font-semibold' : 'text-gray-600'}`}>Check-in ({stats.checkin})</button>
                            <button onClick={() => setTab('accreditato')} className={`px-6 py-3 whitespace-nowrap ${tab === 'accreditato' ? 'border-b-2 border-indigo-600 text-indigo-600 font-semibold' : 'text-gray-600'}`}>Accreditati ({stats.accreditati})</button>
                            <button onClick={() => setTab('checkout')} className={`px-6 py-3 whitespace-nowrap ${tab === 'checkout' ? 'border-b-2 border-indigo-600 text-indigo-600 font-semibold' : 'text-gray-600'}`}>Check-out ({stats.checkout})</button>
                            <button onClick={() => setTab('checkin-giornalieri')} className={`px-6 py-3 whitespace-nowrap ${tab === 'checkin-giornalieri' ? 'border-b-2 border-indigo-600 text-indigo-600 font-semibold' : 'text-gray-600'}`}>Check-in Giornalieri</button>
                            {permissions.canViewEmail && <button onClick={() => setTab('email')} className={`px-6 py-3 whitespace-nowrap ${tab === 'email' ? 'border-b-2 border-indigo-600 text-indigo-600 font-semibold' : 'text-gray-600'}`}>Log Email ({emailLog.length})</button>}
                        </div>

                        {/* TOOLBAR */}
                        <div className="p-4 border-b flex gap-4 flex-wrap">
                            <input type="text" placeholder="Cerca..." value={search} onChange={(e) => setSearch(e.target.value)} className="flex-1 px-3 py-2 border rounded-lg min-w-[200px]" />
                            
                            <button onClick={startScanner} className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 whitespace-nowrap">üì∑ Scansiona Check-in</button>
                            
                            <button onClick={startScannerCheckout} className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 whitespace-nowrap">üì∑ Scansiona Check-out</button>
                            
                            {permissions.canExportCSV && (
                                <>
                                    <button onClick={() => {
                                        const headers = ['Nome', 'Cognome', 'CF', 'Email', 'Tel', 'Tipo Partecipazione', 'Comitato', 'Regione', 'Data Arrivo', 'Data Partenza', 'Modalit√† Viaggio', 'Targa', 'Veicolo', 'Status', 'Accreditamento', 'Data Preiscrizione', 'Data Accreditamento', 'Data Checkout'];
                                        const rows = participants.map(p => [
                                            p.nome, p.cognome, p.cf, p.email, p.tel, p.tipoPartecipazione || '', p.comitato, p.regione, 
                                            p.arrivo || '', p.partenza || '', p.viaggio || '', p.targa || '', p.veicolo || '', p.status,
                                            p.accreditamento === 1 ? 'S√¨' : 'No',
                                            p.dataPreiscrizione ? new Date(p.dataPreiscrizione).toLocaleString('it-IT') : '',
                                            p.dataAccreditamento ? new Date(p.dataAccreditamento).toLocaleString('it-IT') : '',
                                            p.dataCheckout ? new Date(p.dataCheckout).toLocaleString('it-IT') : ''
                                        ]);
                                        const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                                        const blob = new Blob([csv], { type: 'text/csv' });
                                        const url = URL.createObjectURL(blob);
                                        const a = document.createElement('a');
                                        a.href = url;
                                        a.download = `palasciano_${new Date().toISOString().split('T')[0]}.csv`;
                                        a.click();
                                    }} className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 whitespace-nowrap">üì• Esporta CSV</button>
                                    
                                    {tab === 'checkin-giornalieri' && (
                                        <>
                                            <button onClick={() => {
                                                const selectedDate = document.querySelector('input[type="date"]')?.value || new Date().toISOString().split('T')[0];
                                                printRegistroPresenze(participants, selectedDate);
                                            }} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 whitespace-nowrap">üñ®Ô∏è Stampa Registro</button>
                                            
                                            <button onClick={() => {
                                                const selectedDate = document.querySelector('input[type="date"]')?.value || new Date().toISOString().split('T')[0];
                                                printCheckinList(participants, selectedDate);
                                            }} className="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 whitespace-nowrap">üñ®Ô∏è Stampa Lista</button>
                                        </>
                                    )}
                                </>
                            )}
                        </div>{/* CONTENUTO TABS */}
                        <div className="p-6">
                            {tab === 'checkout' ? (
                                <div className="space-y-4">
                                    {filtered.filter(p => p.status === 'checkout').map(p => {
                                        const qr = generateQR({ id: p.id, nome: p.nome, cognome: p.cognome, cf: p.cf });
                                        return (
                                            <div key={p.id} className="border rounded-lg p-4 bg-purple-50 hover:shadow-md transition">
                                                <div className="flex justify-between items-start gap-4">
                                                    <div className="flex-1">
                                                        <div className="flex items-center gap-2 mb-2">
                                                            <h3 className="font-semibold text-lg">{p.nome} {p.cognome}</h3>
                                                            {p.emailSent && <span className="text-xs px-2 py-1 bg-green-100 text-green-700 rounded-full">Email</span>}
                                                            <span className="text-xs px-2 py-1 bg-purple-100 text-purple-700 rounded-full">Check-out</span>
                                                        </div>
                                                        <p className="text-sm text-gray-600">{p.email} ‚Ä¢ {p.tel}</p>
                                                        <p className="text-sm text-gray-600">{p.comitato} - {p.regione}</p>
                                                        {p.tipoPartecipazione && <p className="text-sm text-gray-600">Tipo: {p.tipoPartecipazione}</p>}
                                                        <p className="text-sm text-gray-600">Periodo: {p.arrivo} / {p.partenza}</p>
                                                        {p.dataCheckout && <p className="text-xs text-gray-500 mt-1">Check-out: {new Date(p.dataCheckout).toLocaleString('it-IT')}</p>}
                                                    </div>
                                                    <div className="flex flex-col gap-2">
                                                        <button onClick={() => setShowQR({ qr, name: `${p.nome} ${p.cognome}`, recipient: p.email })} className="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-sm whitespace-nowrap">QR</button>
                                                        {permissions.canEdit && <button onClick={() => setEdit(p)} className="px-3 py-1 bg-yellow-600 text-white rounded hover:bg-yellow-700 text-sm whitespace-nowrap">Modifica</button>}
                                                        {permissions.canDelete && <button onClick={() => onDelete(p.id)} className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm whitespace-nowrap">Elimina</button>}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                    {filtered.filter(p => p.status === 'checkout').length === 0 && (
                                        <div className="text-center py-12 text-gray-500">
                                            <p className="text-4xl mb-2">üëã</p>
                                            <p>Nessun check-out ancora</p>
                                        </div>
                                    )}
                                </div>
                            ) : tab === 'checkin-giornalieri' ? (
                                <CheckinGiornalieriTab participants={filtered} />
                            ) : tab === 'email' ? (
                                <div className="space-y-3">
                                    {emailLog.length === 0 ? (
                                        <div className="text-center py-12 text-gray-500"><p className="text-4xl mb-2">üìß</p><p>Nessuna email</p></div>
                                    ) : emailLog.map(log => (
                                        <div key={log.id} className="border rounded-lg p-4 bg-gray-50">
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    <p className="font-semibold">{log.name}</p>
                                                    <p className="text-sm text-gray-600">{log.recipient}</p>
                                                    <p className="text-sm text-gray-600">{log.subject}</p>
                                                    <p className="text-xs text-gray-400 mt-1">{new Date(log.timestamp).toLocaleString('it-IT')}</p>
                                                </div>
                                                <button onClick={() => setShowQR({ qr: log.qr, name: log.name, recipient: log.recipient })} className="px-3 py-1 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200">QR</button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    {filtered.filter(p => tab === 'all' || p.status === tab).map(p => {
                                        const qr = generateQR({ id: p.id, nome: p.nome, cognome: p.cognome, cf: p.cf });
                                        return (
                                            <div key={p.id} className="border rounded-lg p-4 hover:shadow-md transition">
                                                <div className="flex justify-between items-start gap-4">
                                                    <div className="flex-1">
                                                        <div className="flex items-center gap-2 mb-2">
                                                            <h3 className="font-semibold text-lg">{p.nome} {p.cognome}</h3>
                                                            {p.emailSent && <span className="text-xs px-2 py-1 bg-green-100 text-green-700 rounded-full">Email</span>}
                                                        </div>
                                                        <p className="text-sm text-gray-600">{p.email} ‚Ä¢ {p.tel}</p>
                                                        <p className="text-sm text-gray-600">{p.comitato} - {p.regione}</p>
                                                        {p.tipoPartecipazione && <p className="text-sm text-gray-600">Tipo: {p.tipoPartecipazione}</p>}
                                                        <p className="text-sm text-gray-600">Periodo: {p.arrivo} / {p.partenza}</p>
                                                        <p className="text-sm text-gray-600">Viaggio: {p.viaggio}</p>
                                                        {p.targa && p.veicolo && <p className="text-sm text-gray-600">Veicolo: {p.veicolo} - {p.targa}</p>}
                                                        <span className={`inline-block mt-2 px-3 py-1 rounded-full text-sm ${p.status === 'preiscritto' ? 'bg-blue-100 text-blue-800' : p.status === 'checkin' ? 'bg-orange-100 text-orange-800' : p.status === 'accreditato' ? 'bg-green-100 text-green-800' : 'bg-purple-100 text-purple-800'}`}>{p.status}</span>
                                                    </div>
                                                    <div className="flex flex-col gap-2">
                                                        <button onClick={() => setShowQR({ qr, name: `${p.nome} ${p.cognome}`, recipient: p.email })} className="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-sm whitespace-nowrap">QR</button>
                                                        
                                                        <button onClick={() => printBadgeLabel(p.nome, p.cognome)} className="px-3 py-1 bg-teal-600 text-white rounded hover:bg-teal-700 text-sm whitespace-nowrap">üñ®Ô∏è Etichetta</button>
                                                        
                                                        {permissions.canSendEmail && <button onClick={() => onSendEmail(p, 'registration')} className="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm whitespace-nowrap">Email</button>}
                                                        {permissions.canEdit && <button onClick={() => setEdit(p)} className="px-3 py-1 bg-yellow-600 text-white rounded hover:bg-yellow-700 text-sm whitespace-nowrap">Modifica</button>}
                                                        {permissions.canDelete && <button onClick={() => onDelete(p.id)} className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm whitespace-nowrap">Elimina</button>}
                                                        
                                                        {p.status === 'preiscritto' && <button onClick={async () => {
                                                            if (confirm(`Effettuare check-in manuale per ${p.nome} ${p.cognome}?`)) {
                                                                const qrData = { id: p.id, nome: p.nome, cognome: p.cognome, cf: p.cf };
                                                                const response = await fetch('/.netlify/functions/check-in-scan', {
                                                                    method: 'POST',
                                                                    headers: { 'Content-Type': 'application/json' },
                                                                    body: JSON.stringify({ 
                                                                        qrData,
                                                                        staffUser: currentUser ? {
                                                                            id: currentUser.id,
                                                                            username: currentUser.username,
                                                                            nome: currentUser.nome,
                                                                            cognome: currentUser.cognome
                                                                        } : null
                                                                    })
                                                                });
                                                                const result = await response.json();
                                                                if (result.success) {
                                                                    alert(result.message);
                                                                    if (result.action === 'first_checkin') {
                                                                        printBadgeLabel(p.nome, p.cognome);
                                                                    }
                                                                    if (result.participant.needsEmail) { await onSendEmail(result.participant, 'welcome'); }
                                                                    await onReload();
                                                                } else {
                                                                    alert(result.message || 'Errore');
                                                                }
                                                            }
                                                        }} className="px-3 py-1 bg-orange-600 text-white rounded hover:bg-orange-700 text-sm whitespace-nowrap">Check-in</button>}
                                                        
                                                        {permissions.canEdit && p.status === 'checkin' && p.accreditamento === 0 && <button onClick={async () => {
                                                            if (confirm(`Accreditare ${p.nome} ${p.cognome}?`)) {
                                                                await onUpdateStatus(p.id, 'accreditato');
                                                            }
                                                        }} className="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm whitespace-nowrap">Accredita</button>}

                                                        {permissions.canEdit && p.status === 'accreditato' && <button onClick={async () => {
                                                            if (confirm(`Effettuare check-out per ${p.nome} ${p.cognome}?`)) {
                                                                const qrData = { id: p.id, nome: p.nome, cognome: p.cognome, cf: p.cf };
                                                                const response = await fetch('/.netlify/functions/checkout-scan', {
                                                                    method: 'POST',
                                                                    headers: { 'Content-Type': 'application/json' },
                                                                    body: JSON.stringify({ 
                                                                        qrData,
                                                                        staffUser: currentUser ? {
                                                                            id: currentUser.id,
                                                                            username: currentUser.username,
                                                                            nome: currentUser.nome,
                                                                            cognome: currentUser.cognome
                                                                        } : null
                                                                    })
                                                                });
                                                                const result = await response.json();
                                                                if (result.success) {
                                                                    alert(result.message);
                                                                    await onReload();
                                                                } else {
                                                                    alert(result.message || 'Errore');
                                                                }
                                                            }
                                                        }} className="px-3 py-1 bg-purple-600 text-white rounded hover:bg-purple-700 text-sm whitespace-nowrap">Check-out</button>}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                    {filtered.filter(p => tab === 'all' || p.status === tab).length === 0 && <div className="text-center py-12 text-gray-500"><p className="text-4xl mb-2">üë•</p><p>Nessuno</p></div>}
                                </div>
                            )}
                        </div>
                    </div>{/* MODAL SCANNER QR */}
                    {showScanner && (
                        <div className="fixed inset-0 bg-black bg-opacity-95 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg max-w-2xl w-full p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-bold">Scansiona QR Code</h3>
                                    <button onClick={stopScanner} className="text-2xl hover:bg-gray-100 rounded px-2">√ó</button>
                                </div>
                                <div id="qr-reader" className="w-full"></div>
                                <div className="mt-4 text-center"><p className="text-gray-600">Inquadra il QR Code del partecipante</p></div>
                            </div>
                        </div>
                    )}

                    {/* MODAL MOSTRA QR CODE */}
                    {showQR && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onClick={() => setShowQR(null)}>
                            <div className="bg-white rounded-lg max-w-md w-full p-6" onClick={(e) => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-bold">QR Code</h3>
                                    <button onClick={() => setShowQR(null)} className="text-2xl">√ó</button>
                                </div>
                                <div className="text-center space-y-4">
                                    <div className="bg-gray-50 p-4 rounded-lg">
                                        <p className="font-semibold">{showQR.name}</p>
                                        <p className="text-sm text-gray-600">{showQR.recipient}</p>
                                    </div>
                                    <img src={showQR.qr} alt="QR" className="w-64 h-64 mx-auto border-4 border-indigo-200 rounded-lg" />
                                    <button onClick={() => { const a = document.createElement('a'); a.href = showQR.qr; a.download = `QR_${showQR.name}.png`; a.click(); }} className="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Scarica</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MODAL MODIFICA PARTECIPANTE */}
                    {edit && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                            <div className="bg-white rounded-lg max-w-2xl w-full p-6 my-8">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-bold">Modifica</h3>
                                    <button onClick={() => setEdit(null)} className="text-2xl">√ó</button>
                                </div>
                                <div className="space-y-4 max-h-[60vh] overflow-y-auto">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="block text-sm font-medium mb-1">Nome</label><input type="text" value={edit.nome} onChange={(e) => setEdit({...edit, nome: e.target.value})} className="w-full px-3 py-2 border rounded-lg" /></div>
                                        <div><label className="block text-sm font-medium mb-1">Cognome</label><input type="text" value={edit.cognome} onChange={(e) => setEdit({...edit, cognome: e.target.value})} className="w-full px-3 py-2 border rounded-lg" /></div>
                                    </div>
                                    <div><label className="block text-sm font-medium mb-1">CF</label><input type="text" value={edit.cf} onChange={(e) => setEdit({...edit, cf: e.target.value.toUpperCase()})} className="w-full px-3 py-2 border rounded-lg" /></div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="block text-sm font-medium mb-1">Tel</label><input type="tel" value={edit.tel} onChange={(e) => setEdit({...edit, tel: e.target.value})} className="w-full px-3 py-2 border rounded-lg" /></div>
                                        <div><label className="block text-sm font-medium mb-1">Email</label><input type="email" value={edit.email} onChange={(e) => setEdit({...edit, email: e.target.value})} className="w-full px-3 py-2 border rounded-lg" /></div>
                                    </div>
                                    <div><label className="block text-sm font-medium mb-1">Comitato</label><input type="text" value={edit.comitato} onChange={(e) => setEdit({...edit, comitato: e.target.value})} className="w-full px-3 py-2 border rounded-lg" /></div>
                                    <div><label className="block text-sm font-medium mb-1">Regione</label><input type="text" value={edit.regione} onChange={(e) => setEdit({...edit, regione: e.target.value})} className="w-full px-3 py-2 border rounded-lg" /></div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Tipo Partecipazione</label>
                                        <select value={edit.tipoPartecipazione || ''} onChange={(e) => setEdit({...edit, tipoPartecipazione: e.target.value})} className="w-full px-3 py-2 border rounded-lg">
                                            <option value="">Seleziona tipo</option>
                                            <option value="Corsista">Corsista</option>
                                            <option value="Ospite">Ospite</option>
                                            <option value="Staff">Staff</option>
                                            <option value="Trainer">Trainer</option>
                                        </select>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="block text-sm font-medium mb-1">Data Arrivo</label><input type="date" value={edit.arrivo || ''} onChange={(e) => setEdit({...edit, arrivo: e.target.value})} className="w-full px-3 py-2 border rounded-lg" /></div>
                                        <div><label className="block text-sm font-medium mb-1">Data Partenza</label><input type="date" value={edit.partenza || ''} onChange={(e) => setEdit({...edit, partenza: e.target.value})} className="w-full px-3 py-2 border rounded-lg" /></div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Modalit√† Viaggio</label>
                                        <select value={edit.viaggio || ''} onChange={(e) => setEdit({...edit, viaggio: e.target.value})} className="w-full px-3 py-2 border rounded-lg">
                                            <option value="">Seleziona</option>
                                            <option value="Mezzo CRI">Mezzo CRI</option>
                                            <option value="Mezzi Pubblici">Mezzi Pubblici</option>
                                            <option value="Mezzo Privato">Mezzo Privato</option>
                                        </select>
                                    </div>
                                    {(edit.viaggio === 'Mezzo CRI' || edit.viaggio === 'Mezzo Privato') && (
                                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 space-y-3">
                                            <h4 className="font-medium">Info Veicolo</h4>
                                            <div><label className="block text-sm font-medium mb-1">Targa</label><input type="text" value={edit.targa || ''} onChange={(e) => setEdit({...edit, targa: e.target.value.toUpperCase()})} className="w-full px-3 py-2 border rounded-lg" /></div>
                                            <div><label className="block text-sm font-medium mb-1">Marca e Modello</label><input type="text" value={edit.veicolo || ''} onChange={(e) => setEdit({...edit, veicolo: e.target.value})} className="w-full px-3 py-2 border rounded-lg" /></div>
                                        </div>
                                    )}
                                </div>
                                <div className="flex gap-2 mt-6">
                                    <button onClick={() => { onUpdate(edit.id, edit); setEdit(null); }} className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Salva</button>
                                    <button onClick={() => setEdit(null)} className="flex-1 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Annulla</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MODAL GESTIONE STAFF */}
                    {showStaffManagement && userRole === 'ADMIN' && currentUser && (
                        <StaffManagementPanel 
                            currentUserId={currentUser.id}
                            currentUserRole={userRole}
                            onClose={() => setShowStaffManagement(false)}
                        />
                    )}

                    {/* MODAL AUDIT LOG */}
                    {showAuditLog && userRole === 'ADMIN' && currentUser && (
                        <AuditLogViewer 
                            currentUserId={currentUser.id}
                            onClose={() => setShowAuditLog(false)}
                        />
                    )}
                </div>
            );
        }// ==================== COMPONENTE CHECKIN GIORNALIERI ====================

        function CheckinGiornalieriTab({ participants }) {
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            
            const participantsWithAccess = participants.filter(p => (p.accessi || []).some(a => a.data === selectedDate));
            
            const checkoutOggi = participants.filter(p => {
                if (!p.dataCheckout) return false;
                const checkoutDate = new Date(p.dataCheckout).toISOString().split('T')[0];
                return checkoutDate === selectedDate;
            });

            const movimentiGiornata = [];

            participantsWithAccess.forEach(p => {
                const accessoOggi = (p.accessi || []).find(a => a.data === selectedDate);
                movimentiGiornata.push({
                    id: p.id,
                    nome: p.nome,
                    cognome: p.cognome,
                    tipo: p.tipoPartecipazione || '-',
                    comitato: p.comitato,
                    periodo: `${p.arrivo} / ${p.partenza}`,
                    movimento: 'checkin',
                    status: accessoOggi && accessoOggi.status === 1 ? 'presente' : 'assente',
                    orario: accessoOggi && accessoOggi.dataCheckin ? new Date(accessoOggi.dataCheckin) : null
                });
            });

            checkoutOggi.forEach(p => {
                movimentiGiornata.push({
                    id: `checkout-${p.id}`,
                    nome: p.nome,
                    cognome: p.cognome,
                    tipo: p.tipoPartecipazione || '-',
                    comitato: p.comitato,
                    periodo: `${p.arrivo} / ${p.partenza}`,
                    movimento: 'checkout',
                    status: 'uscito',
                    orario: new Date(p.dataCheckout)
                });
            });

            movimentiGiornata.sort((a, b) => {
                if (!a.orario && !b.orario) return 0;
                if (!a.orario) return 1;
                if (!b.orario) return -1;
                return b.orario - a.orario;
            });

            const presenti = participantsWithAccess.filter(p => {
                const acc = (p.accessi || []).find(a => a.data === selectedDate);
                return acc && acc.status === 1;
            }).length;

            const assenti = participantsWithAccess.length - presenti;

            return (
                <div className="space-y-4">
                    <div className="flex items-center gap-4 bg-gray-50 p-4 rounded-lg">
                        <label className="font-medium">Seleziona Data:</label>
                        <input type="date" value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} className="px-3 py-2 border rounded-lg" />
                    </div>

                    <div className="bg-white border rounded-lg overflow-hidden">
                        <div className="bg-gradient-to-r from-indigo-50 to-purple-50 border-b px-4 py-3">
                            <h3 className="font-semibold text-gray-900">üìã Riepilogo Movimenti Giornata</h3>
                            <p className="text-sm text-gray-600 mt-1">{movimentiGiornata.length} movimenti totali</p>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-gray-100">
                                    <tr>
                                        <th className="text-left p-3">Nome</th>
                                        <th className="text-left p-3">Cognome</th>
                                        <th className="text-left p-3">Tipo</th>
                                        <th className="text-left p-3">Comitato</th>
                                        <th className="text-left p-3">Periodo</th>
                                        <th className="text-center p-3">Movimento</th>
                                        <th className="text-center p-3">Status</th>
                                        <th className="text-center p-3">Orario</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {movimentiGiornata.map(m => (
                                        <tr key={m.id} className={`border-b hover:bg-gray-50 ${m.movimento === 'checkout' ? 'bg-purple-25' : ''}`}>
                                            <td className="p-3 font-medium">{m.nome}</td>
                                            <td className="p-3 font-medium">{m.cognome}</td>
                                            <td className="p-3 text-sm">{m.tipo}</td>
                                            <td className="p-3 text-sm">{m.comitato}</td>
                                            <td className="p-3 text-xs text-gray-600">{m.periodo}</td>
                                            <td className="p-3 text-center">
                                                {m.movimento === 'checkin' ? (
                                                    <span className="px-3 py-1 bg-indigo-100 text-indigo-800 rounded-full text-sm font-medium">
                                                        ‚ûú Check-in
                                                    </span>
                                                ) : (
                                                    <span className="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-medium">
                                                        ‚Üê Check-out
                                                    </span>
                                                )}
                                            </td>
                                            <td className="p-3 text-center">
                                                {m.status === 'presente' && (
                                                    <span className="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">‚úì Presente</span>
                                                )}
                                                {m.status === 'assente' && (
                                                    <span className="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm">‚úó Assente</span>
                                                )}
                                                {m.status === 'uscito' && (
                                                    <span className="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm">üëã Uscito</span>
                                                )}
                                            </td>
                                            <td className="p-3 text-center">
                                                {m.orario ? (
                                                    <span className="font-semibold text-sm">
                                                        {m.orario.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit', timeZone: 'Europe/Rome' })}
                                                    </span>
                                                ) : (
                                                    <span className="text-gray-400 text-sm">-</span>
                                                )}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            {movimentiGiornata.length === 0 && (
                                <div className="text-center py-12 text-gray-500">
                                    <p className="text-4xl mb-2">üìÖ</p>
                                    <p>Nessun movimento registrato per questa data</p>
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        <div className="bg-gradient-to-br from-green-50 to-green-100 border border-green-200 rounded-lg p-4">
                            <h4 className="font-semibold text-green-900 mb-3">‚úÖ Check-in</h4>
                            <div className="space-y-2 text-sm">
                                <div className="flex justify-between">
                                    <span className="text-green-700">Previsti:</span>
                                    <span className="font-bold text-green-900">{participantsWithAccess.length}</span>
                                </div>
                                <div className="flex justify-between">
                                    <span className="text-green-700">Presenti:</span>
                                    <span className="font-bold text-green-900">{presenti}</span>
                                </div>
                                <div className="flex justify-between">
                                    <span className="text-green-700">Assenti:</span>
                                    <span className="font-bold text-red-700">{assenti}</span>
                                </div>
                            </div>
                        </div>

                        <div className="bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 rounded-lg p-4">
                            <h4 className="font-semibold text-purple-900 mb-3">üëã Check-out</h4>
                            <div className="space-y-2 text-sm">
                                <div className="flex justify-between">
                                    <span className="text-purple-700">Usciti oggi:</span>
                                    <span className="font-bold text-purple-900">{checkoutOggi.length}</span>
                                </div>
                                <div className="flex justify-between">
                                    <span className="text-purple-700">Ancora presenti:</span>
                                    <span className="font-bold text-purple-900">{presenti - checkoutOggi.length}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }// ==================== COMPONENTE GESTIONE STAFF (PARTE 1) ====================

        function StaffManagementPanel({ currentUserId, currentUserRole, onClose }) {
            const [staffUsers, setStaffUsers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showCreateForm, setShowCreateForm] = useState(false);
            const [showCredentials, setShowCredentials] = useState(null);
            const [formData, setFormData] = useState({
                username: '',
                nome: '',
                cognome: '',
                email: '',
                ruolo: 'STAFF_CHECKIN',
                note: ''
            });

            useEffect(() => {
                loadStaffUsers();
            }, []);

            const loadStaffUsers = async () => {
                try {
                    setLoading(true);
                    const response = await fetch('/.netlify/functions/manage-users', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'list', adminUserId: currentUserId })
                    });
                    const result = await response.json();
                    if (result.success) {
                        setStaffUsers(result.users);
                    }
                } catch (error) {
                    console.error('Errore caricamento staff:', error);
                    alert('Errore caricamento utenti');
                } finally {
                    setLoading(false);
                }
            };

            const createUser = async (e) => {
                e.preventDefault();
                
                if (!formData.username || !formData.nome || !formData.cognome || !formData.email) {
                    alert('Compila tutti i campi obbligatori');
                    return;
                }

                try {
                    const response = await fetch('/.netlify/functions/manage-users', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            action: 'create', 
                            adminUserId: currentUserId,
                            ...formData 
                        })
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        setShowCredentials({
                            user: result.user,
                            credentials: result.credentials
                        });
                        
                        await fetch('/.netlify/functions/send-credentials-email', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                user: result.user, 
                                credentials: result.credentials,
                                isReset: false
                            })
                        });

                        setFormData({
                            username: '', nome: '', cognome: '', email: '',
                            ruolo: 'STAFF_CHECKIN', note: ''
                        });
                        setShowCreateForm(false);
                        loadStaffUsers();
                    } else {
                        alert(result.error || 'Errore creazione utente');
                    }
                } catch (error) {
                    console.error('Errore:', error);
                    alert('Errore creazione utente');
                }
            };

            const resetPassword = async (userId, user) => {
                if (!confirm(`Reimpostare la password per ${user.nome} ${user.cognome}?`)) return;

                try {
                    const response = await fetch('/.netlify/functions/manage-users', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            action: 'reset_password', 
                            adminUserId: currentUserId,
                            userId: userId
                        })
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        setShowCredentials({
                            user: result.user,
                            credentials: result.credentials
                        });

                        await fetch('/.netlify/functions/send-credentials-email', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                user: result.user, 
                                credentials: result.credentials,
                                isReset: true
                            })
                        });

                        alert('Password reimpostata e email inviata!');
                    } else {
                        alert(result.error || 'Errore reset password');
                    }
                } catch (error) {
                    console.error('Errore:', error);
                    alert('Errore reset password');
                }
            };

            const toggleUserStatus = async (userId, currentStatus) => {
                const action = currentStatus ? 'disattivare' : 'attivare';
                if (!confirm(`Vuoi ${action} questo utente?`)) return;

                try {
                    const user = staffUsers.find(u => u.id === userId);
                    const response = await fetch('/.netlify/functions/manage-users', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            action: 'update', 
                            adminUserId: currentUserId,
                            userId: userId,
                            ...user,
                            attivo: !currentStatus
                        })
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        loadStaffUsers();
                        alert(`Utente ${action}to con successo`);
                    }
                } catch (error) {
                    console.error('Errore:', error);
                    alert('Errore modifica stato');
                }
            };

            const deleteUser = async (userId, user) => {
                if (!confirm(`ATTENZIONE!\n\nEliminare definitivamente l'utente ${user.nome} ${user.cognome}?\n\nQuesta azione non pu√≤ essere annullata.`)) return;

                try {
                    const response = await fetch('/.netlify/functions/manage-users', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            action: 'delete', 
                            adminUserId: currentUserId,
                            userId: userId
                        })
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        loadStaffUsers();
                        alert('Utente eliminato');
                    }
                } catch (error) {
                    console.error('Errore:', error);
                    alert('Errore eliminazione');
                }
            };

            const getRuoloBadge = (ruolo) => {
                const badges = {
                    'ADMIN': { text: 'Amministratore', color: 'bg-purple-100 text-purple-800' },
                    'STAFF_CHECKIN': { text: 'Staff Check-in', color: 'bg-blue-100 text-blue-800' },
                    'STAFF_ACCREDITAMENTO': { text: 'Staff Accreditamento', color: 'bg-green-100 text-green-800' }
                };
                return badges[ruolo] || { text: ruolo, color: 'bg-gray-100 text-gray-800' };
            };return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                    <div className="bg-white rounded-lg max-w-6xl w-full my-8">
                        <div className="p-6 border-b flex justify-between items-center">
                            <div>
                                <h2 className="text-2xl font-bold text-gray-900">üë• Gestione Staff</h2>
                                <p className="text-sm text-gray-600 mt-1">Crea e gestisci gli account del personale</p>
                            </div>
                            <button onClick={onClose} className="text-2xl hover:bg-gray-100 rounded px-3">√ó</button>
                        </div>

                        <div className="p-6">
                            {!showCreateForm && (
                                <button 
                                    onClick={() => setShowCreateForm(true)}
                                    className="mb-6 px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold flex items-center gap-2"
                                >
                                    <span className="text-xl">+</span> Crea Nuovo Utente Staff
                                </button>
                            )}

                            {showCreateForm && (
                                <div className="mb-6 bg-indigo-50 border-2 border-indigo-200 rounded-lg p-6">
                                    <h3 className="text-lg font-bold mb-4 text-indigo-900">Crea Nuovo Utente</h3>
                                    <form onSubmit={createUser} className="space-y-4">
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Username *</label>
                                                <input type="text" required value={formData.username}
                                                    onChange={(e) => setFormData({...formData, username: e.target.value.toLowerCase()})}
                                                    className="w-full px-3 py-2 border rounded-lg" placeholder="es: mario.rossi" />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Email *</label>
                                                <input type="email" required value={formData.email}
                                                    onChange={(e) => setFormData({...formData, email: e.target.value})}
                                                    className="w-full px-3 py-2 border rounded-lg" />
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Nome *</label>
                                                <input type="text" required value={formData.nome}
                                                    onChange={(e) => setFormData({...formData, nome: e.target.value})}
                                                    className="w-full px-3 py-2 border rounded-lg" />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-1">Cognome *</label>
                                                <input type="text" required value={formData.cognome}
                                                    onChange={(e) => setFormData({...formData, cognome: e.target.value})}
                                                    className="w-full px-3 py-2 border rounded-lg" />
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Ruolo *</label>
                                            <select value={formData.ruolo} onChange={(e) => setFormData({...formData, ruolo: e.target.value})}
                                                className="w-full px-3 py-2 border rounded-lg">
                                                <option value="STAFF_CHECKIN">Staff Check-in (Solo scansione QR)</option>
                                                <option value="STAFF_ACCREDITAMENTO">Staff Accreditamento (Check-in + Modifiche)</option>
                                                <option value="ADMIN">Amministratore (Accesso completo)</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Note (opzionale)</label>
                                            <textarea value={formData.note} onChange={(e) => setFormData({...formData, note: e.target.value})}
                                                className="w-full px-3 py-2 border rounded-lg" rows="2" placeholder="Turno, orari, etc..."></textarea>
                                        </div>
                                        <div className="flex gap-2">
                                            <button type="submit" className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                                                ‚úÖ Crea Utente e Invia Email
                                            </button>
                                            <button type="button" onClick={() => setShowCreateForm(false)}
                                                className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
                                                Annulla
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            )}

                            {loading ? (
                                <div className="text-center py-12">
                                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div>
                                    <p className="mt-4 text-gray-600">Caricamento...</p>
                                </div>
                            ) : (
                                <div className="space-y-3">
                                    {staffUsers.map(user => (
                                        <div key={user.id} className={`border rounded-lg p-4 ${!user.attivo ? 'bg-gray-50 opacity-60' : 'bg-white'}`}>
                                            <div className="flex justify-between items-start">
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-3 mb-2">
                                                        <h3 className="font-bold text-lg">{user.nome} {user.cognome}</h3>
                                                        <span className={`px-3 py-1 rounded-full text-xs font-semibold ${getRuoloBadge(user.ruolo).color}`}>
                                                            {getRuoloBadge(user.ruolo).text}
                                                        </span>
                                                        {!user.attivo && <span className="px-2 py-1 bg-red-100 text-red-800 rounded text-xs font-semibold">DISATTIVATO</span>}
                                                        {user.primo_accesso && <span className="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs font-semibold">PRIMO ACCESSO</span>}
                                                    </div>
                                                    <div className="text-sm text-gray-600 space-y-1">
                                                        <p>üë§ <strong>Username:</strong> {user.username}</p>
                                                        <p>üìß <strong>Email:</strong> {user.email}</p>
                                                        <p>üìÖ <strong>Creato:</strong> {new Date(user.data_creazione).toLocaleString('it-IT', { timeZone: 'Europe/Rome' })}</p>
                                                        {user.data_ultimo_accesso && (
                                                            <p>üïê <strong>Ultimo accesso:</strong> {new Date(user.data_ultimo_accesso).toLocaleString('it-IT', { timeZone: 'Europe/Rome' })}</p>
                                                        )}
                                                        {user.note && <p>üìù <strong>Note:</strong> {user.note}</p>}
                                                    </div>
                                                </div>
                                                <div className="flex flex-col gap-2 ml-4">
                                                    <button onClick={() => resetPassword(user.id, user)}
                                                        className="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm whitespace-nowrap">
                                                        üîê Reset Password
                                                    </button>
                                                    <button onClick={() => toggleUserStatus(user.id, user.attivo)}
                                                        className={`px-3 py-1 rounded text-sm whitespace-nowrap ${user.attivo ? 'bg-orange-600 text-white hover:bg-orange-700' : 'bg-green-600 text-white hover:bg-green-700'}`}>
                                                        {user.attivo ? '‚è∏Ô∏è Disattiva' : '‚ñ∂Ô∏è Attiva'}
                                                    </button>
                                                    {user.id !== currentUserId && (
                                                        <button onClick={() => deleteUser(user.id, user)}
                                                            className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm whitespace-nowrap">
                                                            üóëÔ∏è Elimina
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                    {staffUsers.length === 0 && (
                                        <div className="text-center py-12 text-gray-500">
                                            <p className="text-4xl mb-2">üë•</p>
                                            <p>Nessun utente staff</p>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>

                    {showCredentials && (
                        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg max-w-md w-full p-6">
                                <h3 className="text-xl font-bold mb-4 text-center">üéâ Utente Creato!</h3>
                                <div className="bg-green-50 border-2 border-green-200 rounded-lg p-6 mb-4">
                                    <p className="text-center mb-4 text-green-800">Email inviata a <strong>{showCredentials.user.email}</strong></p>
                                    <div className="bg-white border border-green-300 rounded p-4">
                                        <p className="text-sm text-gray-600 mb-2">Username:</p>
                                        <p className="font-bold text-lg font-mono mb-4">{showCredentials.credentials.username}</p>
                                        <p className="text-sm text-gray-600 mb-2">Password:</p>
                                        <p className="font-bold text-lg font-mono">{showCredentials.credentials.password}</p>
                                    </div>
                                </div>
                                <p className="text-sm text-gray-600 text-center mb-4">‚ö†Ô∏è Salva queste credenziali! Non potranno essere visualizzate di nuovo.</p>
                                <button onClick={() => setShowCredentials(null)}
                                    className="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                                    Chiudi
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }// ==================== COMPONENTE AUDIT LOG ====================

        function AuditLogViewer({ currentUserId, onClose }) {
            const [logs, setLogs] = useState([]);
            const [loading, setLoading] = useState(true);
            const [filter, setFilter] = useState('all');
            const [searchUser, setSearchUser] = useState('');

            useEffect(() => {
                loadAuditLog();
            }, []);

            const loadAuditLog = async () => {
                try {
                    setLoading(true);
                    const response = await fetch('/.netlify/functions/get-audit-log', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ adminUserId: currentUserId })
                    });
                    const result = await response.json();
                    if (result.success) {
                        setLogs(result.logs);
                    }
                } catch (error) {
                    console.error('Errore caricamento audit log:', error);
                } finally {
                    setLoading(false);
                }
            };

            const azioneColors = {
                'LOGIN_SUCCESS': 'bg-green-100 text-green-800',
                'LOGIN_FAILED': 'bg-red-100 text-red-800',
                'CHECKIN_FIRST': 'bg-blue-100 text-blue-800',
                'CHECKIN_DAILY': 'bg-cyan-100 text-cyan-800',
                'ACCREDITAMENTO': 'bg-purple-100 text-purple-800',
                'CHECKOUT': 'bg-orange-100 text-orange-800',
                'CREATE_USER': 'bg-green-100 text-green-800',
                'UPDATE_USER': 'bg-yellow-100 text-yellow-800',
                'DELETE_USER': 'bg-red-100 text-red-800',
                'RESET_PASSWORD': 'bg-pink-100 text-pink-800'
            };

            const azioneIcons = {
                'LOGIN_SUCCESS': 'üîì',
                'LOGIN_FAILED': 'üîí',
                'CHECKIN_FIRST': '‚úÖ',
                'CHECKIN_DAILY': 'üìÖ',
                'ACCREDITAMENTO': 'üéâ',
                'CHECKOUT': 'üëã',
                'CREATE_USER': '‚ûï',
                'UPDATE_USER': '‚úèÔ∏è',
                'DELETE_USER': 'üóëÔ∏è',
                'RESET_PASSWORD': 'üîê'
            };

            const filteredLogs = logs.filter(log => {
                if (filter !== 'all' && !log.azione.includes(filter.toUpperCase())) return false;
                if (searchUser && !log.nome_completo?.toLowerCase().includes(searchUser.toLowerCase()) && !log.username?.toLowerCase().includes(searchUser.toLowerCase())) return false;
                return true;
            });

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                    <div className="bg-white rounded-lg max-w-7xl w-full my-8">
                        <div className="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10">
                            <div>
                                <h2 className="text-2xl font-bold text-gray-900">üìä Audit Log</h2>
                                <p className="text-sm text-gray-600 mt-1">Registro completo di tutte le attivit√†</p>
                            </div>
                            <button onClick={onClose} className="text-2xl hover:bg-gray-100 rounded px-3">√ó</button>
                        </div>

                        <div className="p-6">
                            <div className="mb-6 flex gap-4 flex-wrap">
                                <select value={filter} onChange={(e) => setFilter(e.target.value)}
                                    className="px-3 py-2 border rounded-lg">
                                    <option value="all">Tutte le azioni</option>
                                    <option value="login">Login</option>
                                    <option value="checkin">Check-in</option>
                                    <option value="accreditamento">Accreditamento</option>
                                    <option value="checkout">Check-out</option>
                                    <option value="user">Gestione utenti</option>
                                </select>
                                <input 
                                    type="text"
                                    placeholder="Cerca per utente..."
                                    value={searchUser}
                                    onChange={(e) => setSearchUser(e.target.value)}
                                    className="flex-1 px-3 py-2 border rounded-lg min-w-[200px]"
                                />
                                <button onClick={loadAuditLog}
                                    className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                                    üîÑ Aggiorna
                                </button>
                            </div>

                            {loading ? (
                                <div className="text-center py-12">
                                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div>
                                    <p className="mt-4 text-gray-600">Caricamento...</p>
                                </div>
                            ) : (
                                <div className="space-y-2 max-h-[600px] overflow-y-auto">
                                    {filteredLogs.map(log => (
                                        <div key={log.id} className="border rounded-lg p-4 hover:bg-gray-50 transition">
                                            <div className="flex items-start justify-between gap-4">
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-3 mb-2">
                                                        <span className={`px-3 py-1 rounded-full text-xs font-semibold ${azioneColors[log.azione] || 'bg-gray-100 text-gray-800'}`}>
                                                            {azioneIcons[log.azione] || 'üìù'} {log.azione}
                                                        </span>
                                                        <span className="text-sm text-gray-600">
                                                            {new Date(log.timestamp).toLocaleString('it-IT', { 
                                                                day: '2-digit', 
                                                                month: '2-digit', 
                                                                year: 'numeric',
                                                                hour: '2-digit', 
                                                                minute: '2-digit',
                                                                second: '2-digit'
                                                            })}
                                                        </span>
                                                    </div>
                                                    <div className="text-sm">
                                                        <p className="font-semibold text-gray-900">
                                                            üë§ {log.nome_completo || log.username || 'Sistema'}
                                                        </p>
                                                        {log.dettagli && (
                                                            <div className="mt-2 text-xs text-gray-600 bg-gray-50 rounded p-2 font-mono">
                                                                {JSON.stringify(log.dettagli, null, 2)}
                                                            </div>
                                                        )}
                                                        {log.ip_address && (
                                                            <p className="text-xs text-gray-500 mt-1">üåê IP: {log.ip_address}</p>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                    {filteredLogs.length === 0 && (
                                        <div className="text-center py-12 text-gray-500">
                                            <p className="text-4xl mb-2">üìã</p>
                                            <p>Nessuna attivit√† trovata</p>
                                        </div>
                                    )}
                                </div>
                            )}

                            <div className="mt-6 pt-6 border-t text-center text-sm text-gray-600">
                                <p>üìä Totale eventi: <strong>{filteredLogs.length}</strong> / {logs.length}</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== RENDER APP ====================
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>