<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palasciano 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            const [view, setView] = useState('home');
            const [participants, setParticipants] = useState([]);
            const [emailLog, setEmailLog] = useState([]);
            const [userRole, setUserRole] = useState(null);
            const [toast, setToast] = useState({ show: false, message: '' });
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (userRole) {
                    loadParticipants();
                }
            }, [userRole]);

            const loadParticipants = async () => {
                try {
                    setLoading(true);
                    const response = await fetch('/.netlify/functions/get-participants');
                    const result = await response.json();
                    
                    if (result.success) {
                        setParticipants(result.participants);
                        console.log('âœ… Caricati', result.participants.length, 'partecipanti dal database');
                    }
                } catch (error) {
                    console.error('âŒ Errore caricamento:', error);
                    showToast('âŒ Errore caricamento dati');
                } finally {
                    setLoading(false);
                }
            };

            const showToast = (msg) => {
                setToast({ show: true, message: msg });
                setTimeout(() => setToast({ show: false, message: '' }), 3000);
            };

            const generateQR = (data) => {
                const tempDiv = document.createElement('div');
                tempDiv.style.display = 'none';
                document.body.appendChild(tempDiv);
                
                const qr = new QRCode(tempDiv, {
                    text: JSON.stringify(data),
                    width: 300,
                    height: 300,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                const canvas = tempDiv.querySelector('canvas');
                const dataUrl = canvas.toDataURL('image/png');
                document.body.removeChild(tempDiv);
                
                return dataUrl;
            };

            const sendEmail = async (p, type) => {
                const qr = generateQR({ id: p.id, nome: p.nome, cognome: p.cognome, cf: p.cf });
                
                const subject = type === 'welcome' ? 'ðŸŽ‰ Benvenuto al Campo Palasciano 2025!' : 'âœ… Conferma Preiscrizione - Palasciano 2025';
                
                const htmlContent = `
<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"></head>
<body style="font-family:Arial,sans-serif;background:#f3f4f6;padding:20px;">
<div style="max-width:600px;margin:0 auto;background:white;border-radius:8px;overflow:hidden;">
  <div style="padding:0;">
    <img src="https://palasciano2025.netlify.app/images/banner.jpg" alt="Palasciano 2025 - CRI Napoli" style="width:100%;height:auto;display:block;" />
  </div>
  <div style="padding:40px 30px;">
    <h2 style="color:#1f2937;margin:0 0 20px;">Ciao ${p.nome}!</h2>
    <p style="color:#4b5563;line-height:1.6;margin:0 0 20px;">
      ${type === 'welcome' 
        ? 'Benvenuto al Campo Palasciano 2025! Sei stato accreditato con successo. Ti aspettiamo!' 
        : 'Siamo felici di confermare la tua preiscrizione al Campo di Formazione Palasciano 2025.'}
    </p>
    ${type !== 'welcome' ? `
    <div style="text-align:center;margin:30px 0;">
      <p style="color:#4b5563;margin:0 0 15px;font-weight:600;">Il Tuo QR Code Personale</p>
      <img src="${qr}" alt="QR Code" style="width:250px;height:250px;border:3px solid #4f46e5;border-radius:12px;"/>
      <p style="color:#6b7280;margin:15px 0 0;font-size:13px;">Presenta questo QR Code durante il check-in</p>
    </div>` : ''}
    <div style="background:#f9fafb;padding:20px;border-radius:8px;margin:20px 0;">
      <p style="margin:0 0 10px;color:#6b7280;font-size:14px;"><strong>Nome:</strong> ${p.nome} ${p.cognome}</p>
      <p style="margin:0 0 10px;color:#6b7280;font-size:14px;"><strong>CF:</strong> ${p.cf}</p>
      <p style="margin:0 0 10px;color:#6b7280;font-size:14px;"><strong>Tipo Partecipazione:</strong> ${p.tipoPartecipazione || 'Non specificato'}</p>
      <p style="margin:0 0 10px;color:#6b7280;font-size:14px;"><strong>Comitato:</strong> ${p.comitato}</p>
      <p style="margin:0 0 10px;color:#6b7280;font-size:14px;"><strong>Regione:</strong> ${p.regione}</p>
      <p style="margin:0 0 10px;color:#6b7280;font-size:14px;"><strong>Modalita Viaggio:</strong> ${p.viaggio}</p>
      ${p.targa && p.veicolo ? `<p style="margin:0 0 10px;color:#6b7280;font-size:14px;"><strong>Veicolo:</strong> ${p.veicolo} - Targa: ${p.targa}</p>` : ''}
      ${p.arrivo && p.partenza ? `<p style="margin:0;color:#6b7280;font-size:14px;"><strong>Periodo:</strong> ${p.arrivo} / ${p.partenza}</p>` : ''}
    </div>
    <p style="color:#4b5563;margin:20px 0 0;">
      <strong>Un caro saluto,</strong><br>
      <span style="color:#4f46e5;font-weight:600;">Lo Staff Palasciano 2025</span>
    </p>
  </div>
  <div style="background:#f9fafb;padding:30px 20px;text-align:center;border-top:1px solid #e5e7eb;">
    <p style="color:#6b7280;margin:0;font-size:14px;">Croce Rossa Italiana</p>
  </div>
</div>
</body>
</html>`;

                try {
                    const response = await fetch('/.netlify/functions/send-email', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            recipient: p.email,
                            subject: subject,
                            htmlContent: htmlContent,
                            qrData: { id: p.id, nome: p.nome, cognome: p.cognome, cf: p.cf }
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        const log = {
                            id: Date.now(),
                            timestamp: new Date().toISOString(),
                            recipient: p.email,
                            name: `${p.nome} ${p.cognome}`,
                            subject: subject,
                            qr: qr,
                            messageId: result.messageId
                        };
                        setEmailLog(prev => [log, ...prev]);
                        console.log('âœ… Email inviata via Mailgun:', result.messageId);
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('âŒ Errore invio email:', error);
                    const log = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        recipient: p.email,
                        name: `${p.nome} ${p.cognome}`,
                        subject: subject + ' (ERRORE)',
                        qr: qr,
                        error: error.message
                    };
                    setEmailLog(prev => [log, ...prev]);
                }
            };

            const addParticipant = async (data) => {
                const p = { 
                    id: Date.now(), 
                    ...data, 
                    status: 'preiscritto', 
                    emailSent: false 
                };
                
                try {
                    const response = await fetch('/.netlify/functions/save-participant', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(p)
                    });

                    const result = await response.json();

                    if (result.success) {
                        await sendEmail(p, 'registration');
                        
                        p.emailSent = true;
                        await fetch('/.netlify/functions/update-participant', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(p)
                        });

                        showToast('âœ… Preiscrizione completata! Email inviata');
                        console.log('âœ… Partecipante salvato:', p.email);
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('âŒ Errore salvataggio:', error);
                    showToast('âŒ Errore durante la registrazione');
                }
            };

            const updateParticipant = async (id, data) => {
                try {
                    const updatedData = { ...data, id };
                    
                    const response = await fetch('/.netlify/functions/update-participant', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updatedData)
                    });

                    const result = await response.json();

                    if (result.success) {
                        await loadParticipants();
                        showToast('âœï¸ Partecipante aggiornato');
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('âŒ Errore aggiornamento:', error);
                    showToast('âŒ Errore aggiornamento');
                }
            };

            const deleteParticipant = async (id) => {
                if (!confirm('Eliminare questo partecipante?')) return;
                
                try {
                    const response = await fetch('/.netlify/functions/delete-participant', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id })
                    });

                    const result = await response.json();

                    if (result.success) {
                        await loadParticipants();
                        showToast('ðŸ—‘ï¸ Eliminato');
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('âŒ Errore eliminazione:', error);
                    showToast('âŒ Errore eliminazione');
                }
            };

            const updateStatus = async (id, status) => {
                try {
                    const participant = participants.find(p => p.id === id);
                    if (!participant) return;

                    const updatedData = { ...participant, status };
                    
                    const response = await fetch('/.netlify/functions/update-participant', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updatedData)
                    });

                    const result = await response.json();

                    if (result.success) {
                        await loadParticipants();
                        
                        if (status === 'accreditato') {
                            await sendEmail(participant, 'welcome');
                            showToast('ðŸŽ‰ Accreditato! Email di benvenuto inviata');
                        } else {
                            showToast(`Status: ${status}`);
                        }
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('âŒ Errore cambio status:', error);
                    showToast('âŒ Errore aggiornamento status');
                }
            };

            const stats = {
                total: participants.length,
                preiscritti: participants.filter(p => p.status === 'preiscritto').length,
                checkin: participants.filter(p => p.status === 'checkin').length,
                accreditati: participants.filter(p => p.status === 'accreditato').length
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
                    <header className="bg-white shadow-lg">
                        <div className="max-w-7xl mx-auto px-4 py-4">
                            <img 
                                src="/images/banner.jpg" 
                                alt="Palasciano 2025 - CRI Napoli" 
                                className="w-full h-auto max-h-32 object-contain"
                            />
                        </div>
                    </header>

                    {!userRole && view === 'home' && <RegistrationForm onSubmit={addParticipant} onAdminClick={() => setView('login')} />}
                    {view === 'login' && !userRole && <LoginForm onLogin={(role) => { setUserRole(role); setView('dash'); }} onBack={() => setView('home')} />}
                    {userRole && (
                        loading ? (
                            <div className="flex items-center justify-center min-h-[50vh]">
                                <div className="text-center">
                                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                                    <p className="text-gray-600">Caricamento dati...</p>
                                </div>
                            </div>
                        ) : (
                            <Dashboard 
                                participants={participants} 
                                emailLog={emailLog} 
                                stats={stats}
                                userRole={userRole}
                                onUpdateStatus={updateStatus} 
                                onUpdate={updateParticipant} 
                                onDelete={deleteParticipant} 
                                onSendEmail={sendEmail} 
                                generateQR={generateQR} 
                                onLogout={() => { setUserRole(null); setView('home'); }} 
                            />
                        )
                    )}

                    {toast.show && (
                        <div className="fixed top-4 right-4 z-50 bg-green-50 border border-green-200 rounded-lg shadow-lg p-4">
                            <p className="font-medium text-green-900">{toast.message}</p>
                        </div>
                    )}
                </div>
            );
        }

        function RegistrationForm({ onSubmit, onAdminClick }) {
            const [form, setForm] = useState({ nome: '', cognome: '', cf: '', tel: '', email: '', tipoPartecipazione: '', comitato: '', regione: '', arrivo: '', partenza: '', viaggio: '', targa: '', veicolo: '' });
            const [success, setSuccess] = useState(false);
            const regions = ['Abruzzo', 'Basilicata', 'Calabria', 'Campania', 'Emilia-Romagna', 'Friuli-Venezia Giulia', 'Lazio', 'Liguria', 'Lombardia', 'Marche', 'Molise', 'Piemonte', 'Puglia', 'Sardegna', 'Sicilia', 'Toscana', 'Trentino-Alto Adige', 'Umbria', "Valle d'Aosta", 'Veneto'];
            const tipiPartecipazione = ['Corsista', 'Ospite', 'Staff', 'Trainer'];

            const handleSubmit = async (e) => {
                e.preventDefault();
                await onSubmit(form);
                setForm({ nome: '', cognome: '', cf: '', tel: '', email: '', tipoPartecipazione: '', comitato: '', regione: '', arrivo: '', partenza: '', viaggio: '', targa: '', veicolo: '' });
                setSuccess(true);
                setTimeout(() => setSuccess(false), 5000);
            };

            return (
                <div className="max-w-3xl mx-auto px-4 py-8">
                    <div className="bg-white rounded-lg shadow-xl p-8">
                        <h2 className="text-2xl font-bold mb-6">Preiscrizione Online</h2>
                        {success && <div className="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg"><p className="font-semibold text-green-900">Completata! Riceverai email con QR Code</p></div>}
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="block text-sm font-medium mb-1">Nome *</label><input required type="text" value={form.nome} onChange={(e) => setForm({...form, nome: e.target.value})} className="w-full px-3 py-2 border rounded-lg" /></div>
                                <div><label className="block text-sm font-medium mb-1">Cognome *</label><input required type="text" value={form.cognome} onChange={(e) => setForm({...form, cognome: e.target.value})} className="w-full px-3 py-2 border rounded-lg" /></div>
                            </div>
                            <div><label className="block text-sm font-medium mb-1">Codice Fiscale *</label><input required type="text" maxLength="16" value={form.cf} onChange={(e) => setForm({...form, cf: e.target.value.toUpperCase()})} className="w-full px-3 py-2 border rounded-lg" /></div>
                            <div>
                                <label className="block text-sm font-medium mb-1">Tipo Partecipazione *</label>
                                <select required value={form.tipoPartecipazione} onChange={(e) => setForm({...form, tipoPartecipazione: e.target.value})} className="w-full px-3 py-2 border rounded-lg">
                                    <option value="">Seleziona tipo</option>
                                    {tipiPartecipazione.map(t => <option key={t} value={t}>{t}</option>)}
                                </select>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="block text-sm font-medium mb-1">Cellulare *</label><input required type="tel" value={form.tel} onChange={(e) => setForm({...form, tel: e.target.value})} className="w-full px-3 py-2 border rounded-lg" /></div>
                                <div><label className="block text-sm font-medium mb-1">Email *</label><input required type="email" value={form.email} onChange={(e) => setForm({...form, email: e.target.value})} className="w-full px-3 py-2 border rounded-lg" /></div>
                            </div>
                            <div><label className="block text-sm font-medium mb-1">Comitato CRI *</label><input required type="text" value={form.comitato} onChange={(e) => setForm({...form, comitato: e.target.value})} className="w-full px-3 py-2 border rounded-lg" /></div>
                            <div><label className="block text-sm font-medium mb-1">Regione *</label><select required value={form.regione} onChange={(e) => setForm({...form, regione: e.target.value})} className="w-full px-3 py-2 border rounded-lg"><option value="">Seleziona</option>{regions.map(r => <option key={r} value={r}>{r}</option>)}</select></div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="block text-sm font-medium mb-1">Data Arrivo *</label><input required type="date" value={form.arrivo} onChange={(e) => setForm({...form, arrivo: e.target.value})} className="w-full px-3 py-2 border rounded-lg" /></div>
                                <div><label className="block text-sm font-medium mb-1">Data Partenza *</label><input required type="date" value={form.partenza} onChange={(e) => setForm({...form, partenza: e.target.value})} className="w-full px-3 py-2 border rounded-lg" /></div>
                            </div>
                            <div><label className="block text-sm font-medium mb-1">Modalita Viaggio *</label><select required value={form.viaggio} onChange={(e) => setForm({...form, viaggio: e.target.value})} className="w-full px-3 py-2 border rounded-lg"><option value="">Seleziona</option><option>Mezzo CRI</option><option>Mezzi Pubblici</option><option>Mezzo Privato</option></select></div>
                            {(form.viaggio === 'Mezzo CRI' || form.viaggio === 'Mezzo Privato') && (
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 space-y-3">
                                    <h3 className="font-medium">Info Veicolo</h3>
                                    <input required type="text" placeholder="Targa" value={form.targa} onChange={(e) => setForm({...form, targa: e.target.value.toUpperCase()})} className="w-full px-3 py-2 border rounded-lg" />
                                    <input required type="text" placeholder="Marca e Modello" value={form.veicolo} onChange={(e) => setForm({...form, veicolo: e.target.value})} className="w-full px-3 py-2 border rounded-lg" />
                                </div>
                            )}
                            <button type="submit" className="w-full px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold">Completa Preiscrizione</button>
                            <button type="button" onClick={onAdminClick} className="w-full px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Area Staff</button>
                        </form>
                    </div>
                </div>
            );
        }

        function LoginForm({ onLogin, onBack }) {
            const [pwd, setPwd] = useState('');
            
            const handleLogin = () => {
                let role = null;
                if (pwd === 'palasciano2025') role = 'ADMIN';
                else if (pwd === 'checkin2025') role = 'STAFF_CHECKIN';
                else if (pwd === 'accredito2025') role = 'STAFF_ACCREDITAMENTO';
                
                if (role) {
                    onLogin(role);
                } else {
                    alert('Password errata!');
                }
            };
            
            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
                        <h2 className="text-2xl font-bold mb-6 text-center">Accesso Staff</h2>
                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                            <p className="text-sm text-blue-900 font-medium mb-2">Ruoli disponibili:</p>
                            <ul className="text-xs text-blue-800 space-y-1">
                                <li><strong>ADMIN</strong> - Accesso completo</li>
                                <li><strong>STAFF CHECK-IN</strong> - Solo scansione check-in</li>
                                <li><strong>STAFF ACCREDITAMENTO</strong> - Accreditamento + modifiche</li>
                            </ul>
                        </div>
                        <div className="space-y-4">
                            <div><label className="block text-sm font-medium mb-2">Password</label><input type="password" value={pwd} onChange={(e) => setPwd(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleLogin()} className="w-full px-4 py-2 border rounded-lg" placeholder="Inserisci la tua password" /></div>
                            <button onClick={handleLogin} className="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Accedi</button>
                            <button onClick={onBack} className="w-full px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Indietro</button>
                        </div>
                    </div>
                </div>
            );
        }

        function Dashboard({ participants, emailLog, stats, userRole, onUpdateStatus, onUpdate, onDelete, onSendEmail, generateQR, onLogout }) {
            const [tab, setTab] = useState('all');
            const [search, setSearch] = useState('');
            const [edit, setEdit] = useState(null);
            const [showQR, setShowQR] = useState(null);
            const [showScanner, setShowScanner] = useState(false);
            const [scannerInstance, setScannerInstance] = useState(null);

            // Permessi basati sul ruolo
            const permissions = {
                canDelete: userRole === 'ADMIN',
                canEdit: userRole === 'ADMIN' || userRole === 'STAFF_ACCREDITAMENTO',
                canSendEmail: userRole === 'ADMIN',
                canExportCSV: userRole === 'ADMIN' || userRole === 'STAFF_ACCREDITAMENTO',
                canAccredit: userRole === 'ADMIN' || userRole === 'STAFF_ACCREDITAMENTO',
                canCheckin: true,
                canViewEmail: userRole === 'ADMIN'
            };

            const getRoleBadge = () => {
                const badges = {
                    'ADMIN': { text: 'Amministratore', color: 'bg-purple-100 text-purple-800' },
                    'STAFF_CHECKIN': { text: 'Staff Check-in', color: 'bg-blue-100 text-blue-800' },
                    'STAFF_ACCREDITAMENTO': { text: 'Staff Accreditamento', color: 'bg-green-100 text-green-800' }
                };
                return badges[userRole];
            };

            const filtered = participants.filter(p => p.nome.toLowerCase().includes(search.toLowerCase()) || p.cognome.toLowerCase().includes(search.toLowerCase()) || p.email.toLowerCase().includes(search.toLowerCase()));

            const startScanner = () => {
                setShowScanner(true);
                setTimeout(() => {
                    const html5QrCode = new Html5Qrcode("qr-reader");
                    setScannerInstance(html5QrCode);
                    
                    html5QrCode.start(
                        { facingMode: "environment" },
                        { fps: 10, qrbox: { width: 250, height: 250 } },
                        (decodedText) => {
                            try {
                                const data = JSON.parse(decodedText);
                                console.log('QR Scansionato:', data);
                                
                                if (data.id && data.nome && data.cognome) {
                                    const participant = participants.find(p => 
                                        String(p.id) === String(data.id) || 
                                        (p.nome === data.nome && p.cognome === data.cognome && p.cf === data.cf)
                                    );
                                    
                                    if (participant) {
                                        html5QrCode.stop().then(() => {
                                            setScannerInstance(null);
                                            setShowScanner(false);
                                        });
                                        
                                        if (participant.status === 'preiscritto') {
                                            onUpdateStatus(participant.id, 'checkin');
                                            alert(`Check-in completato!\n\n${data.nome} ${data.cognome}\nCF: ${data.cf}`);
                                        } else if (participant.status === 'checkin') {
                                            if (permissions.canAccredit && confirm(`${data.nome} ${data.cognome} e gia in check-in.\n\nVuoi accreditarlo?`)) {
                                                onUpdateStatus(participant.id, 'accreditato');
                                            }
                                        } else {
                                            alert(`${data.nome} ${data.cognome}\ne gia accreditato!`);
                                        }
                                    } else {
                                        alert(`Partecipante non trovato!\n\nNome: ${data.nome} ${data.cognome}\nID QR: ${data.id}`);
                                    }
                                } else {
                                    alert('QR Code non valido!');
                                }
                            } catch (e) {
                                alert('Errore lettura QR: ' + e.message);
                            }
                        },
                        (errorMessage) => {}
                    ).catch(err => {
                        alert('Impossibile avviare fotocamera');
                    });
                }, 100);
            };

            const stopScanner = () => {
                if (scannerInstance) {
                    scannerInstance.stop().then(() => {
                        setScannerInstance(null);
                        setShowScanner(false);
                    }).catch(() => {
                        setShowScanner(false);
                    });
                } else {
                    setShowScanner(false);
                }
            };

            return (
                <div className="max-w-7xl mx-auto px-4 py-8">
                    <div className="mb-6 flex items-center justify-between">
                        <span className={`px-4 py-2 rounded-full text-sm font-semibold ${getRoleBadge().color}`}>
                            {getRoleBadge().text}
                        </span>
                        <button onClick={onLogout} className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 text-sm">
                            Esci
                        </button>
                    </div>

                    <div className="grid grid-cols-4 gap-6 mb-8">
                        <div className="bg-white rounded-lg shadow p-6"><p className="text-gray-500 text-sm">Totale</p><p className="text-3xl font-bold">{stats.total}</p></div>
                        <div className="bg-white rounded-lg shadow p-6"><p className="text-gray-500 text-sm">Preiscritti</p><p className="text-3xl font-bold text-blue-600">{stats.preiscritti}</p></div>
                        <div className="bg-white rounded-lg shadow p-6"><p className="text-gray-500 text-sm">Check-in</p><p className="text-3xl font-bold text-orange-600">{stats.checkin}</p></div>
                        <div className="bg-white rounded-lg shadow p-6"><p className="text-gray-500 text-sm">Accreditati</p><p className="text-3xl font-bold text-green-600">{stats.accreditati}</p></div>
                    </div>

                    <div className="bg-white rounded-lg shadow">
                        <div className="flex border-b overflow-x-auto">
                            <button onClick={() => setTab('all')} className={`px-6 py-3 whitespace-nowrap ${tab === 'all' ? 'border-b-2 border-indigo-600 text-indigo-600 font-semibold' : 'text-gray-600'}`}>Tutti ({stats.total})</button>
                            <button onClick={() => setTab('preiscritto')} className={`px-6 py-3 whitespace-nowrap ${tab === 'preiscritto' ? 'border-b-2 border-indigo-600 text-indigo-600 font-semibold' : 'text-gray-600'}`}>Preiscritti ({stats.preiscritti})</button>
                            <button onClick={() => setTab('checkin')} className={`px-6 py-3 whitespace-nowrap ${tab === 'checkin' ? 'border-b-2 border-indigo-600 text-indigo-600 font-semibold' : 'text-gray-600'}`}>Check-in ({stats.checkin})</button>
                            <button onClick={() => setTab('accreditato')} className={`px-6 py-3 whitespace-nowrap ${tab === 'accreditato' ? 'border-b-2 border-indigo-600 text-indigo-600 font-semibold' : 'text-gray-600'}`}>Accreditati ({stats.accreditati})</button>
                            {permissions.canViewEmail && <button onClick={() => setTab('email')} className={`px-6 py-3 whitespace-nowrap ${tab === 'email' ? 'border-b-2 border-indigo-600 text-indigo-600 font-semibold' : 'text-gray-600'}`}>Log Email ({emailLog.length})</button>}
                        </div>

                        <div className="p-4 border-b flex gap-4 flex-wrap">
                            <input type="text" placeholder="Cerca..." value={search} onChange={(e) => setSearch(e.target.value)} className="flex-1 px-3 py-2 border rounded-lg min-w-[200px]" />
                            {permissions.canCheckin && (
                                <button onClick={startScanner} className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 whitespace-nowrap flex items-center gap-2">
                                    Scansiona QR
                                </button>
                            )}
                            {permissions.canExportCSV && (
                                <button onClick={() => {
                                    const headers = ['Nome', 'Cognome', 'CF', 'Email', 'Tel', 'Tipo', 'Comitato', 'Regione', 'Arrivo', 'Partenza', 'Viaggio', 'Stato'];
                                    const rows = participants.map(p => [p.nome, p.cognome, p.cf, p.email, p.tel, p.tipoPartecipazione || '', p.comitato, p.regione, p.arrivo, p.partenza, p.viaggio, p.status]);
                                    const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                                    const blob = new Blob([csv], { type: 'text/csv' });
                                    const url = URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = `palasciano_${new Date().toISOString().split('T')[0]}.csv`;
                                    a.click();
                                }} className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 whitespace-nowrap">
                                    Esporta CSV
                                </button>
                            )}
                        </div>

                        <div className="p-6">
                            {tab === 'email' ? (
                                <div className="space-y-3">
                                    {emailLog.length === 0 ? <div className="text-center py-12 text-gray-500"><p className="text-4xl mb-2">ðŸ“§</p><p>Nessuna email</p></div> : emailLog.map(log => (
                                        <div key={log.id} className="border rounded-lg p-4 bg-gray-50">
                                            <div className="flex justify-between items-start">
                                                <div><p className="font-semibold">{log.name}</p><p className="text-sm text-gray-600">{log.recipient}</p><p className="text-sm text-gray-600">{log.subject}</p><p className="text-xs text-gray-400 mt-1">{new Date(log.timestamp).toLocaleString('it-IT')}</p></div>
                                                <button onClick={() => setShowQR({ qr: log.qr, name: log.name, recipient: log.recipient })} className="px-3 py-1 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200">QR</button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    {filtered.filter(p => tab === 'all' || p.status === tab).map(p => {
                                        const qr = generateQR({ id: p.id, nome: p.nome, cognome: p.cognome, cf: p.cf });
                                        return (
                                            <div key={p.id} className="border rounded-lg p-4 hover:shadow-md transition">
                                                <div className="flex justify-between items-start gap-4">
                                                    <div className="flex-1">
                                                        <div className="flex items-center gap-2 mb-2">
                                                            <h3 className="font-semibold text-lg">{p.nome} {p.cognome}</h3>
                                                            {p.emailSent && <span className="text-xs px-2 py-1 bg-green-100 text-green-700 rounded-full">Email</span>}
                                                        </div>
                                                        <p className="text-sm text-gray-600">{p.email} â€¢ {p.tel}</p>
                                                        <p className="text-sm text-gray-600">{p.comitato} - {p.regione}</p>
                                                        {p.tipoPartecipazione && <p className="text-sm text-gray-600">Tipo: {p.tipoPartecipazione}</p>}
                                                        <span className={`inline-block mt-2 px-3 py-1 rounded-full text-sm ${p.status === 'preiscritto' ? 'bg-blue-100 text-blue-800' : p.status === 'checkin' ? 'bg-orange-100 text-orange-800' : 'bg-green-100 text-green-800'}`}>{p.status}</span>
                                                    </div>
                                                    <div className="flex flex-col gap-2">
                                                        <button onClick={() => setShowQR({ qr, name: `${p.nome} ${p.cognome}`, recipient: p.email })} className="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-sm whitespace-nowrap">QR</button>
                                                        {permissions.canSendEmail && <button onClick={() => onSendEmail(p, 'registration')} className="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm whitespace-nowrap">Email</button>}
                                                        {permissions.canEdit && <button onClick={() => setEdit(p)} className="px-3 py-1 bg-yellow-600 text-white rounded hover:bg-yellow-700 text-sm whitespace-nowrap">Modifica</button>}
                                                        {permissions.canDelete && <button onClick={() => onDelete(p.id)} className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm whitespace-nowrap">Elimina</button>}
                                                        {permissions.canCheckin && p.status === 'preiscritto' && <button onClick={() => onUpdateStatus(p.id, 'checkin')} className="px-3 py-1 bg-orange-600 text-white rounded hover:bg-orange-700 text-sm whitespace-nowrap">Check-in</button>}
                                                        {permissions.canAccredit && p.status === 'checkin' && <button onClick={() => onUpdateStatus(p.id, 'accreditato')} className="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm whitespace-nowrap">Accredita</button>}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                    {filtered.filter(p => tab === 'all' || p.status === tab).length === 0 && <div className="text-center py-12 text-gray-500"><p className="text-4xl mb-2">ðŸ‘¥</p><p>Nessuno</p></div>}
                                </div>
                            )}
                        </div>
                    </div>

                    {showScanner && (
                        <div className="fixed inset-0 bg-black bg-opacity-95 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg max-w-2xl w-full p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-bold">Scansiona QR Code</h3>
                                    <button onClick={stopScanner} className="text-2xl hover:bg-gray-100 rounded px-2">Ã—</button>
                                </div>
                                <div id="qr-reader" className="w-full"></div>
                                <div className="mt-4 text-center">
                                    <p className="text-gray-600">Inquadra il QR Code del partecipante</p>
                                    <p className="text-sm text-gray-500 mt-2">Il check-in sara automatico dopo la scansione</p>
                                </div>
                            </div>
                        </div>
                    )}

                    {showQR && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onClick={() => setShowQR(null)}>
                            <div className="bg-white rounded-lg max-w-md w-full p-6" onClick={(e) => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-bold">QR Code</h3>
                                    <button onClick={() => setShowQR(null)} className="text-2xl">Ã—</button>
                                </div>
                                <div className="text-center space-y-4">
                                    <div className="bg-gray-50 p-4 rounded-lg">
                                        <p className="font-semibold">{showQR.name}</p>
                                        <p className="text-sm text-gray-600">{showQR.recipient}</p>
                                    </div>
                                    <img src={showQR.qr} alt="QR" className="w-64 h-64 mx-auto border-4 border-indigo-200 rounded-lg" />
                                    <button onClick={() => { const a = document.createElement('a'); a.href = showQR.qr; a.download = `QR_${showQR.name}.png`; a.click(); }} className="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Scarica</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {edit && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                            <div className="bg-white rounded-lg max-w-2xl w-full p-6 my-8">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-bold">Modifica Partecipante</h3>
                                    <button onClick={() => setEdit(null)} className="text-2xl">Ã—</button>
                                </div>
                                <div className="space-y-4 max-h-[60vh] overflow-y-auto">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="block text-sm font-medium mb-1">Nome</label><input type="text" value={edit.nome} onChange={(e) => setEdit({...edit, nome: e.target.value})} className="w-full px-3 py-2 border rounded-lg" /></div>
                                        <div><label className="block text-sm font-medium mb-1">Cognome</label><input type="text" value={edit.cognome} onChange={(e) => setEdit({...edit, cognome: e.target.value})} className="w-full px-3 py-2 border rounded-lg" /></div>
                                    </div>
                                    <div><label className="block text-sm font-medium mb-1">CF</label><input type="text" value={edit.cf} onChange={(e) => setEdit({...edit, cf: e.target.value.toUpperCase()})} className="w-full px-3 py-2 border rounded-lg" /></div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="block text-sm font-medium mb-1">Tel</label><input type="tel" value={edit.tel} onChange={(e) => setEdit({...edit, tel: e.target.value})} className="w-full px-3 py-2 border rounded-lg" /></div>
                                        <div><label className="block text-sm font-medium mb-1">Email</label><input type="email" value={edit.email} onChange={(e) => setEdit({...edit, email: e.target.value})} className="w-full px-3 py-2 border rounded-lg" /></div>
                                    </div>
                                    <div><label className="block text-sm font-medium mb-1">Comitato</label><input type="text" value={edit.comitato} onChange={(e) => setEdit({...edit, comitato: e.target.value})} className="w-full px-3 py-2 border rounded-lg" /></div>
                                    <div><label className="block text-sm font-medium mb-1">Regione</label><input type="text" value={edit.regione} onChange={(e) => setEdit({...edit, regione: e.target.value})} className="w-full px-3 py-2 border rounded-lg" /></div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Tipo Partecipazione</label>
                                        <select value={edit.tipoPartecipazione || ''} onChange={(e) => setEdit({...edit, tipoPartecipazione: e.target.value})} className="w-full px-3 py-2 border rounded-lg">
                                            <option value="">Seleziona tipo</option>
                                            <option value="Corsista">Corsista</option>
                                            <option value="Ospite">Ospite</option>
                                            <option value="Staff">Staff</option>
                                            <option value="Trainer">Trainer</option>
                                        </select>
                                    </div>
                                </div>
                                <div className="flex gap-2 mt-6">
                                    <button onClick={() => { onUpdate(edit.id, edit); setEdit(null); }} className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Salva</button>
                                    <button onClick={() => setEdit(null)} className="flex-1 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Annulla</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>

